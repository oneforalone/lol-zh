<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>源代码 &mdash; Let Over Lambda 中文文档  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="生产代码" href="production-code.html" />
    <link rel="prev" title="术语表" href="specification.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Let Over Lambda 中文文档
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">译者序</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter01.html">第一章：概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter02.html">第二章：闭包</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter03.html">第三章：宏基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter04.html">第四章：读取宏 <sup>（1）</sup></a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter05.html">第五章：Programs that program <sup>（1）</sup></a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter06.html">第六章：回指 <sup>（1）</sup> 宏</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter07.html">第七章：宏的效率</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter08.html">第八章：Lisp 和 Forth</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendices.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">参考文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="specification.html">术语表</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">源代码</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#chapter01">Chapter01</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mkstr"><code class="docutils literal notranslate"><span class="pre">mkstr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#symb"><code class="docutils literal notranslate"><span class="pre">symb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#group"><code class="docutils literal notranslate"><span class="pre">group</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#flatten"><code class="docutils literal notranslate"><span class="pre">flatten</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fact"><code class="docutils literal notranslate"><span class="pre">fact</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#choose"><code class="docutils literal notranslate"><span class="pre">choose</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter02">Chapter02</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#block-scanner"><code class="docutils literal notranslate"><span class="pre">block-scanner</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter03">Chapter03</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sleep-uints"><code class="docutils literal notranslate"><span class="pre">sleep-uints%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sleep-units"><code class="docutils literal notranslate"><span class="pre">sleep-uints</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#unit-of-time"><code class="docutils literal notranslate"><span class="pre">unit-of-time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#nlet"><code class="docutils literal notranslate"><span class="pre">nlet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#g-symbol-p"><code class="docutils literal notranslate"><span class="pre">g!-symbol-p</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#defmacro-g"><code class="docutils literal notranslate"><span class="pre">defmacro/g!</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#o-symbol-p"><code class="docutils literal notranslate"><span class="pre">o!-symbol-p</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#o-symbol-to-g-symbol"><code class="docutils literal notranslate"><span class="pre">o!-symbol-to-g!-symbol</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#defmacro"><code class="docutils literal notranslate"><span class="pre">defmacro!</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#nif"><code class="docutils literal notranslate"><span class="pre">nif</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter04">Chapter04</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#reader"><code class="docutils literal notranslate"><span class="pre">#&quot;-reader</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20"><code class="docutils literal notranslate"><span class="pre">#&gt;-reader</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#segment-reader"><code class="docutils literal notranslate"><span class="pre">segment-reader</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#match-mode-ppcre-lambda-form"><code class="docutils literal notranslate"><span class="pre">match-mode-ppcre-lambda-form</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#subst-mode-ppcre-lambda-form"><code class="docutils literal notranslate"><span class="pre">subst-mode-ppcre-lambda-form</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25"><code class="docutils literal notranslate"><span class="pre">#~-reader</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cyclic-p"><code class="docutils literal notranslate"><span class="pre">cyclic-p</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cyclic-p-aux"><code class="docutils literal notranslate"><span class="pre">cyclic-p-aux</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#safe-read-from-string-blacklist"><code class="docutils literal notranslate"><span class="pre">safe-read-from-string-blacklist</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#safe-read-from-string"><code class="docutils literal notranslate"><span class="pre">safe-read-from-string</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter05">Chapter05</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defunits"><code class="docutils literal notranslate"><span class="pre">defunits%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#defunits-chaining"><code class="docutils literal notranslate"><span class="pre">defunits-chaining%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id33"><code class="docutils literal notranslate"><span class="pre">defunits%%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id35"><code class="docutils literal notranslate"><span class="pre">defunits-chaining</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id37"><code class="docutils literal notranslate"><span class="pre">defunits</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#units"><code class="docutils literal notranslate"><span class="pre">units</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#tree-leaves"><code class="docutils literal notranslate"><span class="pre">tree-leaves%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#predicate-splitter"><code class="docutils literal notranslate"><span class="pre">predicate-splitter</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id42"><code class="docutils literal notranslate"><span class="pre">tree-leaves%%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id44"><code class="docutils literal notranslate"><span class="pre">tree-leaves</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#nlet-tail"><code class="docutils literal notranslate"><span class="pre">nlet-tail</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cxr"><code class="docutils literal notranslate"><span class="pre">cxr%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id48"><code class="docutils literal notranslate"><span class="pre">cxr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#def-english-list-accessors"><code class="docutils literal notranslate"><span class="pre">def-english-list-accessors</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cxr-calculator"><code class="docutils literal notranslate"><span class="pre">cxr-calculator</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cxr-symbol-p"><code class="docutils literal notranslate"><span class="pre">cxr-symbol-p</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cxr-symbol-to-cxr-list"><code class="docutils literal notranslate"><span class="pre">cxr-symbol-to-cxr-list</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-all-cxrs"><code class="docutils literal notranslate"><span class="pre">with-all-cxrs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#dlambda"><code class="docutils literal notranslate"><span class="pre">dlambda</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter06">Chapter06</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#alambda"><code class="docutils literal notranslate"><span class="pre">alambda</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#aif"><code class="docutils literal notranslate"><span class="pre">aif</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id58"><code class="docutils literal notranslate"><span class="pre">#`-reader</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#alet"><code class="docutils literal notranslate"><span class="pre">alet%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id61"><code class="docutils literal notranslate"><span class="pre">alet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#alet-fsm"><code class="docutils literal notranslate"><span class="pre">alet-fsm</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ichain-beofre"><code class="docutils literal notranslate"><span class="pre">ichain-beofre</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ichain-after"><code class="docutils literal notranslate"><span class="pre">ichain-after</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ichain-intercept"><code class="docutils literal notranslate"><span class="pre">ichain-intercept%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id66"><code class="docutils literal notranslate"><span class="pre">ichain-intercept</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#alet-hotpatch"><code class="docutils literal notranslate"><span class="pre">alet-hotpatch%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id69"><code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#let-hotpatch"><code class="docutils literal notranslate"><span class="pre">let-hotpatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#let-binding-transform"><code class="docutils literal notranslate"><span class="pre">let-binding-transform</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sublet"><code class="docutils literal notranslate"><span class="pre">sublet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id74"><code class="docutils literal notranslate"><span class="pre">sublet*</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pandoriclet"><code class="docutils literal notranslate"><span class="pre">pandoriclet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pandoriclet-get"><code class="docutils literal notranslate"><span class="pre">pandoriclet-get</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pandoriclet-set"><code class="docutils literal notranslate"><span class="pre">pandoriclet-set</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-pandoric"><code class="docutils literal notranslate"><span class="pre">get-pandoric</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-pandoric"><code class="docutils literal notranslate"><span class="pre">with-pandoric</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pandoric-hotpatch"><code class="docutils literal notranslate"><span class="pre">pandoric-hotpatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pandoric-recode"><code class="docutils literal notranslate"><span class="pre">pandoric-recode</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#plambda"><code class="docutils literal notranslate"><span class="pre">plambda</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-stats-counter"><code class="docutils literal notranslate"><span class="pre">make-stats-counter</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#defpan"><code class="docutils literal notranslate"><span class="pre">defpan</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-noisy-stats-counter"><code class="docutils literal notranslate"><span class="pre">make-noisy-stats-counter</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pandoric-eval"><code class="docutils literal notranslate"><span class="pre">pandoric-eval</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter07">Chapter07</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#set-dispatch-macro-character"><code class="docutils literal notranslate"><span class="pre">set-dispatch-macro-character</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fast-progn"><code class="docutils literal notranslate"><span class="pre">fast-progn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#safe-progn"><code class="docutils literal notranslate"><span class="pre">safe-progn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fast-keywords-strip"><code class="docutils literal notranslate"><span class="pre">fast-keywords-strip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#defun-with-fast-keywords"><code class="docutils literal notranslate"><span class="pre">defun-with-fast-keywords</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#defun-keywords-test"><code class="docutils literal notranslate"><span class="pre">defun-keywords-test</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#keywords-benchmark"><code class="docutils literal notranslate"><span class="pre">keywords-benchmark</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fformat"><code class="docutils literal notranslate"><span class="pre">fformat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fformat-benchmark"><code class="docutils literal notranslate"><span class="pre">fformat-benchmark</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#dis"><code class="docutils literal notranslate"><span class="pre">dis</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pointer"><code class="docutils literal notranslate"><span class="pre">pointer-&amp;</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-fast-stack"><code class="docutils literal notranslate"><span class="pre">with-fast-stack</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-tlist"><code class="docutils literal notranslate"><span class="pre">make-tlist</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#tlist-add"><code class="docutils literal notranslate"><span class="pre">tlist-add</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#tlist-rem"><code class="docutils literal notranslate"><span class="pre">tlist-rem</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#tlist-update"><code class="docutils literal notranslate"><span class="pre">tlist-update</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#counting-cons"><code class="docutils literal notranslate"><span class="pre">counting-cons</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-conses-counted"><code class="docutils literal notranslate"><span class="pre">with-conses-counted</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#counting-push"><code class="docutils literal notranslate"><span class="pre">counting-push</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-cons-pool"><code class="docutils literal notranslate"><span class="pre">with-cons-pool</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cons-pool-cons"><code class="docutils literal notranslate"><span class="pre">cons-pool-cons</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cons-pool-free"><code class="docutils literal notranslate"><span class="pre">cons-pool-free</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-cons-pool-stack"><code class="docutils literal notranslate"><span class="pre">make-cons-pool-stack</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-shared-cons-pool-stack"><code class="docutils literal notranslate"><span class="pre">make-shared-cons-pool-stack</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-dynamic-cons-pools"><code class="docutils literal notranslate"><span class="pre">with-dynamic-cons-pools</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#fill-cons-pool"><code class="docutils literal notranslate"><span class="pre">fill-cons-pool</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#bad-3-sn"><code class="docutils literal notranslate"><span class="pre">bad-3-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#good-3-sn"><code class="docutils literal notranslate"><span class="pre">good-3-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#interpret-sn"><code class="docutils literal notranslate"><span class="pre">interpret-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#all-sn-perms"><code class="docutils literal notranslate"><span class="pre">all-sn-perms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#average-swaps-calc"><code class="docutils literal notranslate"><span class="pre">average-swaps-calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-batcher-sn"><code class="docutils literal notranslate"><span class="pre">build-batcher-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#prune-sn-for-median"><code class="docutils literal notranslate"><span class="pre">prune-sn-for-median</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#prune-sn-for-median-calc"><code class="docutils literal notranslate"><span class="pre">prune-sn-for-median-calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#paeth-9-median-sn"><code class="docutils literal notranslate"><span class="pre">paeth-9-median-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#paeth-25-median-sn"><code class="docutils literal notranslate"><span class="pre">paeth-25-median-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sn-to-lambda-form"><code class="docutils literal notranslate"><span class="pre">sn-to-lambda-form%</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id125"><code class="docutils literal notranslate"><span class="pre">sn-to-lambda-form</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sortf"><code class="docutils literal notranslate"><span class="pre">sortf</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sort-benchmark-time"><code class="docutils literal notranslate"><span class="pre">sort-benchmark-time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#do-sort-benchmark"><code class="docutils literal notranslate"><span class="pre">do-sort-benchmark</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#medianf-get-best-sn"><code class="docutils literal notranslate"><span class="pre">medianf-get-best-sn</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#medianf"><code class="docutils literal notranslate"><span class="pre">medianf</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chapter08">Chapter08</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#forth-word"><code class="docutils literal notranslate"><span class="pre">forth-word</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-lookup"><code class="docutils literal notranslate"><span class="pre">forth-lookup</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-inner-interpreter"><code class="docutils literal notranslate"><span class="pre">forth-inner-interpreter</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#prim-form"><code class="docutils literal notranslate"><span class="pre">prim-form</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#prim-forms"><code class="docutils literal notranslate"><span class="pre">prim-forms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#go-forth"><code class="docutils literal notranslate"><span class="pre">go-forth</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib"><code class="docutils literal notranslate"><span class="pre">forth-stdlib</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#new-forth"><code class="docutils literal notranslate"><span class="pre">new-forth</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-install-prims"><code class="docutils literal notranslate"><span class="pre">forth-install-prims</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-prims"><code class="docutils literal notranslate"><span class="pre">forth-prims</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-compile-in"><code class="docutils literal notranslate"><span class="pre">forth-compile-in</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-handle-found"><code class="docutils literal notranslate"><span class="pre">forth-handle-found</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-handle-not-found"><code class="docutils literal notranslate"><span class="pre">forth-handle-not-found</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-create-name-immediate"><code class="docutils literal notranslate"><span class="pre">forth-create-name-immediate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-create"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-create</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-name-immediate"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-name-immediate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-prim"><code class="docutils literal notranslate"><span class="pre">forth-prim-&#64;-!</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-unary-word-definer"><code class="docutils literal notranslate"><span class="pre">forth-unary-word-definer</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-binary-word-definer"><code class="docutils literal notranslate"><span class="pre">forth-binary-word-definer</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-unary-word-definers"><code class="docutils literal notranslate"><span class="pre">forth-unary-word-definers</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-prim-branch-if"><code class="docutils literal notranslate"><span class="pre">forth-prim-branch-if</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-drop"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-drop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-prim-compile-here"><code class="docutils literal notranslate"><span class="pre">forth-prim-compile-here</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-compile"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-compile</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-here"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-here</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-abs"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-abs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-swap"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-swap</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-mod2"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-mod2</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-stdlib-add-again"><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-again</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-forth-thread"><code class="docutils literal notranslate"><span class="pre">get-forth-thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#print-forth-thread"><code class="docutils literal notranslate"><span class="pre">print-forth-thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#flubify-aux"><code class="docutils literal notranslate"><span class="pre">flubify-aux</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#assemble-flub"><code class="docutils literal notranslate"><span class="pre">assemble-flub</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#flubify"><code class="docutils literal notranslate"><span class="pre">flubify</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#compile-flubified"><code class="docutils literal notranslate"><span class="pre">compile-flubified</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#flubify-thread-shaker"><code class="docutils literal notranslate"><span class="pre">flubify-thread-shaker</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#forth-to-lisp"><code class="docutils literal notranslate"><span class="pre">forth-to-lisp</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="production-code.html">生产代码</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Let Over Lambda 中文文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>源代码</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/original-code.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="original-code">
<span id="id1"></span><h1>源代码<a class="headerlink" href="#original-code" title="Permalink to this heading"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>;; This is the source code for the book
;; _Let_Over_Lambda_ by Doug Hoyte.
;; This code is (C) 2002-2008, Doug Hoyte.
;;
;; You are free to use, modify, and re-distribute
;; this code however you want, except that any
;; modifications must be clearly indicated before
;; re-distribution. There is no warranty,
;; expressed nor implied.
;;
;; Attribution of this code to me, Doug Hoyte, is
;; appreciated but not necessary. If you find the
;; code useful, or would like documentation,
;; please consider buying the book!
</pre></div>
</div>
<section id="chapter01">
<span id="chapter01-src-code"></span><h2>Chapter01<a class="headerlink" href="#chapter01" title="Permalink to this heading"></a></h2>
<section id="mkstr">
<span id="id2"></span><h3><code class="docutils literal notranslate"><span class="pre">mkstr</span></code><a class="headerlink" href="#mkstr" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">mkstr</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">with-output-to-string</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">dolist</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">princ</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">s</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="symb">
<span id="id3"></span><h3><code class="docutils literal notranslate"><span class="pre">symb</span></code><a class="headerlink" href="#symb" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">symb</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">values</span><span class="w"> </span><span class="p">(</span><span class="nb">intern</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">mkstr</span><span class="w"> </span><span class="nv">args</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="group">
<span id="id4"></span><h3><code class="docutils literal notranslate"><span class="pre">group</span></code><a class="headerlink" href="#group" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">group</span><span class="w"> </span><span class="p">(</span><span class="nv">source</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">zerop</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;zero length&quot;</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">((</span><span class="nv">rec</span><span class="w"> </span><span class="p">(</span><span class="nv">source</span><span class="w"> </span><span class="nv">acc</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="nb">nthcdr</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">source</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">consp</span><span class="w"> </span><span class="nb">rest</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nv">rec</span><span class="w"> </span><span class="nb">rest</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nb">subseq</span><span class="w"> </span><span class="nv">source</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="nv">acc</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">source</span><span class="w"> </span><span class="nv">acc</span><span class="p">))))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">source</span><span class="w"> </span><span class="p">(</span><span class="nv">rec</span><span class="w"> </span><span class="nv">source</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"> </span><span class="no">nil</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="flatten">
<span id="id5"></span><h3><code class="docutils literal notranslate"><span class="pre">flatten</span></code><a class="headerlink" href="#flatten" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">flatten</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">((</span><span class="nv">rec</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="nv">acc</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">null</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">acc</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span><span class="nb">atom</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">acc</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="nv">rec</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nv">rec</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">acc</span><span class="p">))))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">rec</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="no">nil</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="fact">
<span id="id6"></span><h3><code class="docutils literal notranslate"><span class="pre">fact</span></code><a class="headerlink" href="#fact" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">fact</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nv">fact</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="choose">
<span id="id7"></span><h3><code class="docutils literal notranslate"><span class="pre">choose</span></code><a class="headerlink" href="#choose" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">choose</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="w"> </span><span class="nv">r</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nv">fact</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">fact</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">r</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">fact</span><span class="w"> </span><span class="nv">r</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="chapter02">
<span id="chapter02-src-code"></span><h2>Chapter02<a class="headerlink" href="#chapter02" title="Permalink to this heading"></a></h2>
<section id="block-scanner">
<span id="id8"></span><h3><code class="docutils literal notranslate"><span class="pre">block-scanner</span></code><a class="headerlink" href="#block-scanner" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">block-scanner</span><span class="w"> </span><span class="p">(</span><span class="nv">trigger-string</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">trig</span><span class="w"> </span><span class="p">(</span><span class="nb">coerce</span><span class="w"> </span><span class="nv">trigger-string</span><span class="w"> </span><span class="ss">&#39;list</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">curr</span><span class="w"> </span><span class="nv">trig</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">data-string</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">data</span><span class="w"> </span><span class="p">(</span><span class="nb">coerce</span><span class="w"> </span><span class="nv">data-string</span><span class="w"> </span><span class="ss">&#39;list</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">dolist</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="w"> </span><span class="nv">data</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">curr</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">curr</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">curr</span><span class="p">)</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">curr</span><span class="p">)</span><span class="w"> </span><span class="c1">; next char</span><span class="w"></span>
<span class="w">                    </span><span class="nv">trig</span><span class="p">))))</span><span class="w">   </span><span class="c1">; start over</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="nv">curr</span><span class="p">)))))</span><span class="w"> </span><span class="c1">; return t if found</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="chapter03">
<span id="chapter03-src-code"></span><h2>Chapter03<a class="headerlink" href="#chapter03" title="Permalink to this heading"></a></h2>
<section id="sleep-uints">
<span id="id9"></span><h3><code class="docutils literal notranslate"><span class="pre">sleep-uints%</span></code><a class="headerlink" href="#sleep-uints" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">sleep-units%</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="nv">unit</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">sleep</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">value</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="nv">unit</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">s</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">m</span><span class="p">)</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">d</span><span class="p">)</span><span class="w"> </span><span class="mi">86400</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">ms</span><span class="p">)</span><span class="w"> </span><span class="m">1/1000</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">us</span><span class="p">)</span><span class="w"> </span><span class="m">1/1000000</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sleep-units">
<span id="id10"></span><h3><code class="docutils literal notranslate"><span class="pre">sleep-uints</span></code><a class="headerlink" href="#sleep-units" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">sleep-units</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="nv">unit</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">sleep</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="o">,</span><span class="nv">value</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="nv">unit</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">s</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">m</span><span class="p">)</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">d</span><span class="p">)</span><span class="w"> </span><span class="mi">86400</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">ms</span><span class="p">)</span><span class="w"> </span><span class="m">1/1000</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">us</span><span class="p">)</span><span class="w"> </span><span class="m">1/1000000</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="unit-of-time">
<span id="id11"></span><h3><code class="docutils literal notranslate"><span class="pre">unit-of-time</span></code><a class="headerlink" href="#unit-of-time" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">unit-of-time</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="nv">unit</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="o">,</span><span class="nv">value</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="nv">unit</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">s</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">m</span><span class="p">)</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">d</span><span class="p">)</span><span class="w"> </span><span class="mi">86400</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">ms</span><span class="p">)</span><span class="w"> </span><span class="m">1/1000</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nv">us</span><span class="p">)</span><span class="w"> </span><span class="m">1/1000000</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="nlet">
<span id="id12"></span><h3><code class="docutils literal notranslate"><span class="pre">nlet</span></code><a class="headerlink" href="#nlet" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">nlet</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="w"> </span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">n</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">car</span><span class="w"> </span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">,@</span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">,</span><span class="nv">n</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">letargs</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="g-symbol-p">
<span id="id13"></span><h3><code class="docutils literal notranslate"><span class="pre">g!-symbol-p</span></code><a class="headerlink" href="#g-symbol-p" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">g!-symbol-p</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">symbolp</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">))</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">string=</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;G!&quot;</span><span class="w"></span>
<span class="w">                </span><span class="ss">:start1</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">                </span><span class="ss">:end1</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="defmacro-g">
<span id="id14"></span><h3><code class="docutils literal notranslate"><span class="pre">defmacro/g!</span></code><a class="headerlink" href="#defmacro-g" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">defmacro/g!</span><span class="w"> </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="nv">args</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">syms</span><span class="w"> </span><span class="p">(</span><span class="nb">remove-duplicates</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">remove-if-not</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">g!-symbol-p</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nv">flatten</span><span class="w"> </span><span class="nv">body</span><span class="p">)))))</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="o">,</span><span class="nv">name</span><span class="w"> </span><span class="o">,</span><span class="nv">args</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">s</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">subseq</span><span class="w"></span>
<span class="w">                                </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                                </span><span class="mi">2</span><span class="p">))))</span><span class="w"></span>
<span class="w">            </span><span class="nv">syms</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="nv">body</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="o-symbol-p">
<span id="id15"></span><h3><code class="docutils literal notranslate"><span class="pre">o!-symbol-p</span></code><a class="headerlink" href="#o-symbol-p" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">o!-symbol-p</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">symbolp</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">))</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">string=</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;O!&quot;</span><span class="w"></span>
<span class="w">                </span><span class="ss">:start1</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">                </span><span class="ss">:end1</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="o-symbol-to-g-symbol">
<span id="id16"></span><h3><code class="docutils literal notranslate"><span class="pre">o!-symbol-to-g!-symbol</span></code><a class="headerlink" href="#o-symbol-to-g-symbol" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">o!-symbol-to-g!-symbol</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nv">symb</span><span class="w"> </span><span class="s">&quot;G!&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">subseq</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="defmacro">
<span id="id17"></span><h3><code class="docutils literal notranslate"><span class="pre">defmacro!</span></code><a class="headerlink" href="#defmacro" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">defmacro!</span><span class="w"> </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="nv">args</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">os</span><span class="w"> </span><span class="p">(</span><span class="nb">remove-if-not</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">o!-symbol-p</span><span class="w"> </span><span class="nv">args</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">gs</span><span class="w"> </span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">o!-symbol-to-g!-symbol</span><span class="w"> </span><span class="nv">os</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nv">defmacro/g!</span><span class="w"> </span><span class="o">,</span><span class="nv">name</span><span class="w"> </span><span class="o">,</span><span class="nv">args</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">,@</span><span class="nv">gs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">,@</span><span class="nv">os</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="p">(</span><span class="k">progn</span><span class="w"> </span><span class="o">,@</span><span class="nv">body</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="nif">
<span id="id18"></span><h3><code class="docutils literal notranslate"><span class="pre">nif</span></code><a class="headerlink" href="#nif" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">nif</span><span class="w"> </span><span class="p">(</span><span class="nv">o!expr</span><span class="w"> </span><span class="nv">pos</span><span class="w"> </span><span class="nv">zero</span><span class="w"> </span><span class="nv">neg</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">plusp</span><span class="w"> </span><span class="o">,</span><span class="nv">g!expr</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">pos</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">zerop</span><span class="w"> </span><span class="o">,</span><span class="nv">g!expr</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">zero</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="o">,</span><span class="nv">neg</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="chapter04">
<span id="chapter04-src-code"></span><h2>Chapter04<a class="headerlink" href="#chapter04" title="Permalink to this heading"></a></h2>
<section id="reader">
<span id="id19"></span><h3><code class="docutils literal notranslate"><span class="pre">#&quot;-reader</span></code><a class="headerlink" href="#reader" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">|#&quot;-reader|</span><span class="w"> </span><span class="p">(</span><span class="nc">stream</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">chars</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">do</span><span class="w"> </span><span class="p">((</span><span class="nv">prev</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"> </span><span class="nv">curr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">curr</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="nv">prev</span><span class="w"> </span><span class="sc">#\&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="nv">curr</span><span class="w"> </span><span class="sc">#\#</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">prev</span><span class="w"> </span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">coerce</span><span class="w"> </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"> </span><span class="nv">chars</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;string</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nb">set-dispatch-macro-character</span><span class="w"></span>
<span class="sc">#\#</span><span class="w"> </span><span class="sc">#\&quot;</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">|#&quot;-reader|</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id20">
<span id="id21"></span><h3><code class="docutils literal notranslate"><span class="pre">#&gt;-reader</span></code><a class="headerlink" href="#id20" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">|#&gt;-reader|</span><span class="w"> </span><span class="p">(</span><span class="nc">stream</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">chars</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">do</span><span class="w"> </span><span class="p">((</span><span class="nv">curr</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">char=</span><span class="w"> </span><span class="sc">#\newline</span><span class="w"> </span><span class="nv">curr</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">curr</span><span class="w"> </span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">pattern</span><span class="w"> </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"> </span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">pointer</span><span class="w"> </span><span class="nv">pattern</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">output</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">do</span><span class="w"> </span><span class="p">((</span><span class="nv">curr</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">null</span><span class="w"> </span><span class="nv">pointer</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">curr</span><span class="w"> </span><span class="nv">output</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pointer</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pointer</span><span class="p">)</span><span class="w"> </span><span class="nv">curr</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">pointer</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="nv">pattern</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">pointer</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">return</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">coerce</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">nthcdr</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">pattern</span><span class="p">)</span><span class="w"> </span><span class="nv">output</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="ss">&#39;string</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="nb">set-dispatch-macro-character</span><span class="w"></span>
<span class="sc">#\#</span><span class="w"> </span><span class="sc">#\&gt;</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">|#&gt;-reader|</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="segment-reader">
<span id="id22"></span><h3><code class="docutils literal notranslate"><span class="pre">segment-reader</span></code><a class="headerlink" href="#segment-reader" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">segment-reader</span><span class="w"> </span><span class="p">(</span><span class="nc">stream</span><span class="w"> </span><span class="nv">ch</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">do</span><span class="w"> </span><span class="p">((</span><span class="nv">curr</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">char=</span><span class="w"> </span><span class="nv">ch</span><span class="w"> </span><span class="nv">curr</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">curr</span><span class="w"> </span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">coerce</span><span class="w"> </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"> </span><span class="nv">chars</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;string</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">segment-reader</span><span class="w"> </span><span class="nc">stream</span><span class="w"> </span><span class="nv">ch</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">1</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="match-mode-ppcre-lambda-form">
<span id="id23"></span><h3><code class="docutils literal notranslate"><span class="pre">match-mode-ppcre-lambda-form</span></code><a class="headerlink" href="#match-mode-ppcre-lambda-form" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="o">#+</span><span class="nv">cl-ppcre</span><span class="w"></span>
<span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">match-mode-ppcre-lambda-form</span><span class="w"> </span><span class="p">(</span><span class="nv">o!args</span><span class="p">)</span><span class="w"></span>
<span class="o">``</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="ss">&#39;,g!str</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">cl-ppcre:scan</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">,</span><span class="nv">g!args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="ss">&#39;,g!str</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="subst-mode-ppcre-lambda-form">
<span id="id24"></span><h3><code class="docutils literal notranslate"><span class="pre">subst-mode-ppcre-lambda-form</span></code><a class="headerlink" href="#subst-mode-ppcre-lambda-form" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="o">#+</span><span class="nv">cl-ppcre</span><span class="w"></span>
<span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">subst-mode-ppcre-lambda-form</span><span class="w"> </span><span class="p">(</span><span class="nv">o!args</span><span class="p">)</span><span class="w"></span>
<span class="o">``</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="ss">&#39;,g!str</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">cl-ppcre:regex-replace-all</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">,</span><span class="nv">g!args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="ss">&#39;,g!str</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="o">,</span><span class="nv">g!args</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id25">
<span id="id26"></span><h3><code class="docutils literal notranslate"><span class="pre">#~-reader</span></code><a class="headerlink" href="#id25" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="o">#+</span><span class="nv">cl-ppcre</span><span class="w"></span>
<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">|#~-reader|</span><span class="w"> </span><span class="p">(</span><span class="nc">stream</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">mode-char</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">char=</span><span class="w"> </span><span class="nv">mode-char</span><span class="w"> </span><span class="sc">#\m</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">match-mode-ppcre-lambda-form</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">segment-reader</span><span class="w"> </span><span class="nc">stream</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="mi">1</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">char=</span><span class="w"> </span><span class="nv">mode-char</span><span class="w"> </span><span class="sc">#\s</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">subst-mode-ppcre-lambda-form</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">segment-reader</span><span class="w"> </span><span class="nc">stream</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nc">stream</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Unknown #~~ mode character&quot;</span><span class="p">)))))</span><span class="w"></span>

<span class="o">#+</span><span class="nv">cl-ppcre</span><span class="w"></span>
<span class="p">(</span><span class="nb">set-dispatch-macro-character</span><span class="w"> </span><span class="sc">#\#</span><span class="w"> </span><span class="sc">#\~</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">|#~-reader|</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cyclic-p">
<span id="id27"></span><h3><code class="docutils literal notranslate"><span class="pre">cyclic-p</span></code><a class="headerlink" href="#cyclic-p" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">cyclic-p</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nv">cyclic-p-aux</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cyclic-p-aux">
<span id="id28"></span><h3><code class="docutils literal notranslate"><span class="pre">cyclic-p-aux</span></code><a class="headerlink" href="#cyclic-p-aux" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">cyclic-p-aux</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="w"> </span><span class="nv">seen</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">consp</span><span class="w"> </span><span class="nv">l</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="nv">seen</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">progn</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="nv">seen</span><span class="p">)</span><span class="w"> </span><span class="no">t</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nv">cyclic-p-aux</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">l</span><span class="p">)</span><span class="w"> </span><span class="nv">seen</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">cyclic-p-aux</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">l</span><span class="p">)</span><span class="w"> </span><span class="nv">seen</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="safe-read-from-string-blacklist">
<span id="id29"></span><h3><code class="docutils literal notranslate"><span class="pre">safe-read-from-string-blacklist</span></code><a class="headerlink" href="#safe-read-from-string-blacklist" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">safe-read-from-string-blacklist</span><span class="w"></span>
<span class="o">&#39;</span><span class="p">(</span><span class="sc">#\#</span><span class="w"> </span><span class="sc">#\:</span><span class="w"> </span><span class="sc">#\|</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">rt</span><span class="w"> </span><span class="p">(</span><span class="nb">copy-readtable</span><span class="w"> </span><span class="no">nil</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">safe-reader-error</span><span class="w"> </span><span class="p">(</span><span class="nc">stream</span><span class="w"> </span><span class="nv">closech</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nc">stream</span><span class="w"> </span><span class="nv">closech</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;safe-read-from-string failure&quot;</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">dolist</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="w"> </span><span class="nv">safe-read-from-string-blacklist</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">set-macro-character</span><span class="w"></span>
<span class="w">    </span><span class="nv">c</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">safe-reader-error</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="nv">rt</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="safe-read-from-string">
<span id="id30"></span><h3><code class="docutils literal notranslate"><span class="pre">safe-read-from-string</span></code><a class="headerlink" href="#safe-read-from-string" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">safe-read-from-string</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="w"> </span><span class="k">&amp;optional</span><span class="w"> </span><span class="nv">fail</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stringp</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="vg">*readtable*</span><span class="w"> </span><span class="nv">rt</span><span class="p">)</span><span class="w"> </span><span class="vg">*read-eval*</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">handler-bind</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">error</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="kt">condition</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="kt">condition</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="k">return-from</span><span class="w"></span>
<span class="w">                    </span><span class="nv">safe-read-from-string</span><span class="w"> </span><span class="nv">fail</span><span class="p">))))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">read-from-string</span><span class="w"> </span><span class="nv">s</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="nv">fail</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="chapter05">
<span id="chapter05-src-code"></span><h2>Chapter05<a class="headerlink" href="#chapter05" title="Permalink to this heading"></a></h2>
<section id="defunits">
<span id="id31"></span><h3><code class="docutils literal notranslate"><span class="pre">defunits%</span></code><a class="headerlink" href="#defunits" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">defunits%</span><span class="w"> </span><span class="p">(</span><span class="nv">quantity</span><span class="w"> </span><span class="nv">base-unit</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">units</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nv">symb</span><span class="w"> </span><span class="ss">&#39;unit-of-</span><span class="w"> </span><span class="nv">quantity</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="nv">g!val</span><span class="w"> </span><span class="o">,</span><span class="nv">g!un</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="o">,,</span><span class="nv">g!val</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="o">,</span><span class="nv">g!un</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="o">,</span><span class="nv">base-unit</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">`</span><span class="p">((</span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nv">group</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="mi">2</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="defunits-chaining">
<span id="id32"></span><h3><code class="docutils literal notranslate"><span class="pre">defunits-chaining%</span></code><a class="headerlink" href="#defunits-chaining" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">defunits-chaining%</span><span class="w"> </span><span class="p">(</span><span class="nv">u</span><span class="w"> </span><span class="nv">units</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">spec</span><span class="w"> </span><span class="p">(</span><span class="nb">find</span><span class="w"> </span><span class="nv">u</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="ss">:key</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">car</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">spec</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Unknown unit ~a&quot;</span><span class="w"> </span><span class="nv">u</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">chain</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">spec</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">listp</span><span class="w"> </span><span class="nv">chain</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">chain</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">defunits-chaining%</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">chain</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="nv">units</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nv">chain</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id33">
<span id="id34"></span><h3><code class="docutils literal notranslate"><span class="pre">defunits%%</span></code><a class="headerlink" href="#id33" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">defunits%%</span><span class="w"> </span><span class="p">(</span><span class="nv">quantity</span><span class="w"> </span><span class="nv">base-unit</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">units</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nv">symb</span><span class="w"> </span><span class="ss">&#39;unit-of-</span><span class="w"> </span><span class="nv">quantity</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="nv">g!val</span><span class="w"> </span><span class="o">,</span><span class="nv">g!un</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="o">,,</span><span class="nv">g!val</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="o">,</span><span class="nv">g!un</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="o">,</span><span class="nv">base-unit</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">`</span><span class="p">((</span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">                        </span><span class="o">,</span><span class="p">(</span><span class="nv">defunits-chaining%</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">base-unit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                                </span><span class="p">(</span><span class="nv">group</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="mi">2</span><span class="p">)))))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nv">group</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="mi">2</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id35">
<span id="id36"></span><h3><code class="docutils literal notranslate"><span class="pre">defunits-chaining</span></code><a class="headerlink" href="#id35" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">defunits-chaining</span><span class="w"> </span><span class="p">(</span><span class="nv">u</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="nv">prev</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">member</span><span class="w"> </span><span class="nv">u</span><span class="w"> </span><span class="nv">prev</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;~{ ~a~^ depends on~}&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">u</span><span class="w"> </span><span class="nv">prev</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">spec</span><span class="w"> </span><span class="p">(</span><span class="nb">find</span><span class="w"> </span><span class="nv">u</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="ss">:key</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">car</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">spec</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Unknown unit ~a&quot;</span><span class="w"> </span><span class="nv">u</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">chain</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">spec</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">listp</span><span class="w"> </span><span class="nv">chain</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">chain</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">defunits-chaining</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">chain</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="nv">units</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">u</span><span class="w"> </span><span class="nv">prev</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="nv">chain</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id37">
<span id="id38"></span><h3><code class="docutils literal notranslate"><span class="pre">defunits</span></code><a class="headerlink" href="#id37" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">defunits</span><span class="w"> </span><span class="p">(</span><span class="nv">quantity</span><span class="w"> </span><span class="nv">base-unit</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">units</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nv">symb</span><span class="w"> </span><span class="ss">&#39;unit-of-</span><span class="w"> </span><span class="nv">quantity</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="o">,</span><span class="nv">g!val</span><span class="w"> </span><span class="o">,</span><span class="nv">g!un</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="o">,,</span><span class="nv">g!val</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="o">,</span><span class="nv">g!un</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="o">,</span><span class="nv">base-unit</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">`</span><span class="p">((</span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">                        </span><span class="o">,</span><span class="p">(</span><span class="nv">defunits-chaining</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nb">cons</span><span class="w"></span>
<span class="w">                                </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">base-unit</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                                </span><span class="p">(</span><span class="nv">group</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="w">                            </span><span class="no">nil</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nv">group</span><span class="w"> </span><span class="nv">units</span><span class="w"> </span><span class="mi">2</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="units">
<span id="id39"></span><h3><code class="docutils literal notranslate"><span class="pre">units</span></code><a class="headerlink" href="#units" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defunits</span><span class="w"> </span><span class="nv">distance</span><span class="w"> </span><span class="nv">m</span><span class="w"></span>
<span class="nv">km</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="nv">cm</span><span class="w"> </span><span class="m">1/100</span><span class="w"></span>
<span class="nv">mm</span><span class="w"> </span><span class="p">(</span><span class="m">1/10</span><span class="w"> </span><span class="nv">cm</span><span class="p">)</span><span class="w"></span>
<span class="nv">nm</span><span class="w"> </span><span class="p">(</span><span class="m">1/1000</span><span class="w"> </span><span class="nv">mm</span><span class="p">)</span><span class="w"></span>

<span class="nv">yard</span><span class="w"> </span><span class="m">9144/10000</span><span class="w"> </span><span class="c1">; Defined in 1956</span><span class="w"></span>
<span class="nv">foot</span><span class="w"> </span><span class="p">(</span><span class="m">1/3</span><span class="w"> </span><span class="nv">yard</span><span class="p">)</span><span class="w"></span>
<span class="nv">inch</span><span class="w"> </span><span class="p">(</span><span class="m">1/12</span><span class="w"> </span><span class="nv">foot</span><span class="p">)</span><span class="w"></span>
<span class="nv">mile</span><span class="w"> </span><span class="p">(</span><span class="mi">1760</span><span class="w"> </span><span class="nv">yard</span><span class="p">)</span><span class="w"></span>
<span class="nv">furlong</span><span class="w"> </span><span class="p">(</span><span class="m">1/8</span><span class="w"> </span><span class="nv">mile</span><span class="p">)</span><span class="w"></span>

<span class="nv">fathom</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="nv">yard</span><span class="p">)</span><span class="w"> </span><span class="c1">; Defined in 1929</span><span class="w"></span>
<span class="nv">nautical-mile</span><span class="w"> </span><span class="mi">1852</span><span class="w"></span>
<span class="nv">cable</span><span class="w"> </span><span class="p">(</span><span class="m">1/10</span><span class="w"> </span><span class="nv">nautical-mile</span><span class="p">)</span><span class="w"></span>

<span class="nv">old-brit-nautical-mile</span><span class="w"> </span><span class="c1">; Dropped in 1970</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="m">6080/3</span><span class="w"> </span><span class="nv">yard</span><span class="p">)</span><span class="w"></span>
<span class="nv">old-brit-cable</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="m">1/10</span><span class="w"> </span><span class="nv">old-brit-nautical-mile</span><span class="p">)</span><span class="w"></span>
<span class="nv">old-brit-fathom</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="m">1/100</span><span class="w"> </span><span class="nv">old-brit-cable</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="tree-leaves">
<span id="id40"></span><h3><code class="docutils literal notranslate"><span class="pre">tree-leaves%</span></code><a class="headerlink" href="#tree-leaves" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tree-leaves%</span><span class="w"> </span><span class="p">(</span><span class="nv">tree</span><span class="w"> </span><span class="nv">result</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">tree</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">listp</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">tree-leaves%</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="nv">result</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">tree-leaves%</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="nv">result</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nv">result</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="predicate-splitter">
<span id="id41"></span><h3><code class="docutils literal notranslate"><span class="pre">predicate-splitter</span></code><a class="headerlink" href="#predicate-splitter" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">predicate-splitter</span><span class="w"> </span><span class="p">(</span><span class="nv">orderp</span><span class="w"> </span><span class="nv">splitp</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">s</span><span class="w"> </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">splitp</span><span class="w"> </span><span class="nv">a</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="nv">s</span><span class="w"> </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">splitp</span><span class="w"> </span><span class="nv">b</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">orderp</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nv">s</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id42">
<span id="id43"></span><h3><code class="docutils literal notranslate"><span class="pre">tree-leaves%%</span></code><a class="headerlink" href="#id42" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tree-leaves%%</span><span class="w"> </span><span class="p">(</span><span class="nv">tree</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="nv">result</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">tree</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">listp</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">tree-leaves%%</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="nv">result</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">tree-leaves%%</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="nv">result</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nv">tree</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id44">
<span id="id45"></span><h3><code class="docutils literal notranslate"><span class="pre">tree-leaves</span></code><a class="headerlink" href="#id44" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">tree-leaves</span><span class="w"> </span><span class="p">(</span><span class="nv">tree</span><span class="w"> </span><span class="nv">test</span><span class="w"> </span><span class="nv">result</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nv">tree-leaves%%</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="nv">tree</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignorable</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="nv">test</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignorable</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="nv">result</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="nlet-tail">
<span id="id46"></span><h3><code class="docutils literal notranslate"><span class="pre">nlet-tail</span></code><a class="headerlink" href="#nlet-tail" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">nlet-tail</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="w"> </span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">gs</span><span class="w"> </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">letargs</span><span class="w"></span>
<span class="w">                </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="k">macrolet</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="o">,</span><span class="nv">n</span><span class="w"> </span><span class="o">,</span><span class="nv">gs</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="k">progn</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">psetq</span><span class="w"></span>
<span class="w">            </span><span class="o">,@</span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">nconc</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">mapcar</span><span class="w"></span>
<span class="w">                        </span><span class="nf">#&#39;</span><span class="nb">list</span><span class="w"></span>
<span class="w">                        </span><span class="ss">&#39;,</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">car</span><span class="w"> </span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">,@</span><span class="nv">gs</span><span class="p">))))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">go</span><span class="w"> </span><span class="o">,</span><span class="ss">&#39;,g!n</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">block</span><span class="w"> </span><span class="o">,</span><span class="nv">g!b</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="o">,</span><span class="nv">letargs</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">tagbody</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nv">g!n</span><span class="w"> </span><span class="p">(</span><span class="k">return-from</span><span class="w"></span>
<span class="w">                    </span><span class="o">,</span><span class="nv">g!b</span><span class="w"> </span><span class="p">(</span><span class="k">progn</span><span class="w"> </span><span class="o">,@</span><span class="nv">body</span><span class="p">))))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cxr">
<span id="id47"></span><h3><code class="docutils literal notranslate"><span class="pre">cxr%</span></code><a class="headerlink" href="#cxr" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">cxr%</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">tree</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="ss">&#39;a</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"> </span><span class="ss">&#39;car</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="ss">&#39;d</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"> </span><span class="ss">&#39;cdr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Non A/D symbol&quot;</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="nv">cxr%</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="nv">cxr%</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="o">,</span><span class="nv">tree</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id48">
<span id="id49"></span><h3><code class="docutils literal notranslate"><span class="pre">cxr</span></code><a class="headerlink" href="#id48" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">cxr-inline-thresh</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">cxr</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="nv">tree</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">tree</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">op</span><span class="w"> </span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="ss">&#39;a</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"> </span><span class="ss">&#39;car</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="ss">&#39;d</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"> </span><span class="ss">&#39;cdr</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Non A/D symbol&quot;</span><span class="p">)))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">integerp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">cxr-inline-thresh</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">op</span><span class="w"> </span><span class="p">(</span><span class="nv">cxr</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">tree</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">op</span><span class="w"> </span><span class="p">(</span><span class="nv">cxr</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="o">,</span><span class="nv">tree</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="nv">nlet-tail</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nv">g!name</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!count</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="o">,</span><span class="nv">g!val</span><span class="w"> </span><span class="p">(</span><span class="nv">cxr</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">tree</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">,</span><span class="nv">g!count</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nv">g!val</span><span class="w"></span>
<span class="w">            </span><span class="c1">;; Will be a tail:</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="o">,</span><span class="nv">g!name</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="o">,</span><span class="nv">g!count</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="o">,</span><span class="nv">op</span><span class="w"> </span><span class="o">,</span><span class="nv">g!val</span><span class="p">))))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="def-english-list-accessors">
<span id="id50"></span><h3><code class="docutils literal notranslate"><span class="pre">def-english-list-accessors</span></code><a class="headerlink" href="#def-english-list-accessors" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">def-english-list-accessors</span><span class="w"> </span><span class="p">(</span><span class="nv">start</span><span class="w"> </span><span class="nv">end</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">end</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Bad start/end range&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">progn</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">end</span><span class="w"> </span><span class="nv">collect</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="nb">defun</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="p">(</span><span class="nv">symb</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;string</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">alpha-char-p</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">char-upcase</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="sc">#\-</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="s">&quot;~:r&quot;</span><span class="w"> </span><span class="nv">i</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">arg</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">cxr</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">d</span><span class="p">)</span><span class="w"> </span><span class="nv">arg</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cxr-calculator">
<span id="id51"></span><h3><code class="docutils literal notranslate"><span class="pre">cxr-calculator</span></code><a class="headerlink" href="#cxr-calculator" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">cxr-calculator</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"></span>
<span class="w">        </span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">i</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cxr-symbol-p">
<span id="id52"></span><h3><code class="docutils literal notranslate"><span class="pre">cxr-symbol-p</span></code><a class="headerlink" href="#cxr-symbol-p" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">cxr-symbol-p</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">symbolp</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">chars</span><span class="w"> </span><span class="p">(</span><span class="nb">coerce</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="ss">&#39;list</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">and</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="sc">#\C</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">chars</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="sc">#\R</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="nv">chars</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="p">(</span><span class="nb">remove-if</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="sc">#\A</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="sc">#\D</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">chars</span><span class="p">))))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cxr-symbol-to-cxr-list">
<span id="id53"></span><h3><code class="docutils literal notranslate"><span class="pre">cxr-symbol-to-cxr-list</span></code><a class="headerlink" href="#cxr-symbol-to-cxr-list" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">cxr-symbol-to-cxr-list</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">((</span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">l</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">list*</span><span class="w"></span>
<span class="w">                </span><span class="mi">1</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">char=</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">l</span><span class="p">)</span><span class="w"> </span><span class="sc">#\A</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="ss">&#39;A</span><span class="w"></span>
<span class="w">                </span><span class="ss">&#39;D</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">l</span><span class="p">))))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">collect</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cdr</span><span class="w">       </span><span class="c1">; chop off C</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="c1">; chop off R</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">coerce</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="ss">&#39;list</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="with-all-cxrs">
<span id="id54"></span><h3><code class="docutils literal notranslate"><span class="pre">with-all-cxrs</span></code><a class="headerlink" href="#with-all-cxrs" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">with-all-cxrs</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">forms</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">labels</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">s</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">cxr</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nv">cxr-symbol-to-cxr-list</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="nv">l</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">remove-duplicates</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">remove-if-not</span><span class="w"></span>
<span class="w">            </span><span class="nf">#&#39;</span><span class="nv">cxr-symbol-p</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">flatten</span><span class="w"> </span><span class="nv">forms</span><span class="p">)))))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="nv">forms</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="dlambda">
<span id="id55"></span><h3><code class="docutils literal notranslate"><span class="pre">dlambda</span></code><a class="headerlink" href="#dlambda" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">dlambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">ds</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="o">,</span><span class="nv">g!args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">case</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">,</span><span class="nv">g!args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">d</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">d</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="no">t</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">d</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">d</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="o">,</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">d</span><span class="p">))</span><span class="w"></span>
<span class="w">                        </span><span class="nv">g!args</span><span class="w"></span>
<span class="w">                        </span><span class="o">`</span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="o">,</span><span class="nv">g!args</span><span class="p">)))))</span><span class="w"></span>
<span class="w">        </span><span class="nv">ds</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="chapter06">
<span id="chapter06-src-code"></span><h2>Chapter06<a class="headerlink" href="#chapter06" title="Permalink to this heading"></a></h2>
<section id="alambda">
<span id="id56"></span><h3><code class="docutils literal notranslate"><span class="pre">alambda</span></code><a class="headerlink" href="#alambda" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="c1">;; Graham&#39;s alambda</span><span class="w"></span>
<span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">alambda</span><span class="w"> </span><span class="p">(</span><span class="nv">parms</span><span class="w"> </span><span class="k">&amp;body</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">((</span><span class="nv">self</span><span class="w"> </span><span class="o">,</span><span class="nv">parms</span><span class="w"> </span><span class="o">,@</span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nf">#&#39;</span><span class="nv">self</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="aif">
<span id="id57"></span><h3><code class="docutils literal notranslate"><span class="pre">aif</span></code><a class="headerlink" href="#aif" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="c1">;; Graham&#39;s aif</span><span class="w"></span>
<span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">aif</span><span class="w"> </span><span class="p">(</span><span class="nv">test</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="k">&amp;optional</span><span class="w"> </span><span class="nv">else</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">it</span><span class="w"> </span><span class="o">,</span><span class="nv">test</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="o">,</span><span class="nv">then</span><span class="w"> </span><span class="o">,</span><span class="nv">else</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id58">
<span id="id59"></span><h3><code class="docutils literal notranslate"><span class="pre">#`-reader</span></code><a class="headerlink" href="#id58" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">|#`-reader|</span><span class="w"> </span><span class="p">(</span><span class="nc">stream</span><span class="w"> </span><span class="nv">sub-char</span><span class="w"> </span><span class="nv">numarg</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nv">sub-char</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">unless</span><span class="w"> </span><span class="nv">numarg</span><span class="w"> </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">numarg</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">numarg</span><span class="w"></span>
<span class="w">                </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nv">symb</span><span class="w"> </span><span class="ss">&#39;a</span><span class="w"> </span><span class="nv">i</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="nb">funcall</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">get-macro-character</span><span class="w"> </span><span class="sc">#\`</span><span class="p">)</span><span class="w"> </span><span class="nc">stream</span><span class="w"> </span><span class="no">nil</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nb">set-dispatch-macro-character</span><span class="w"></span>
<span class="sc">#\#</span><span class="w"> </span><span class="sc">#\`</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nv">|#`-reader|</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="alet">
<span id="id60"></span><h3><code class="docutils literal notranslate"><span class="pre">alet%</span></code><a class="headerlink" href="#alet" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">alet%</span><span class="w"> </span><span class="p">(</span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">this</span><span class="p">)</span><span class="w"> </span><span class="o">,@</span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">this</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id61">
<span id="id62"></span><h3><code class="docutils literal notranslate"><span class="pre">alet</span></code><a class="headerlink" href="#id61" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">alet</span><span class="w"> </span><span class="p">(</span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">this</span><span class="p">)</span><span class="w"> </span><span class="o">,@</span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">params</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">params</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="alet-fsm">
<span id="id63"></span><h3><code class="docutils literal notranslate"><span class="pre">alet-fsm</span></code><a class="headerlink" href="#alet-fsm" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">alet-fsm</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">states</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">macrolet</span><span class="w"> </span><span class="p">((</span><span class="nv">state</span><span class="w"> </span><span class="p">(</span><span class="nv">s</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">`</span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nf">#&#39;</span><span class="o">,</span><span class="nv">s</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">(</span><span class="o">,@</span><span class="nv">states</span><span class="p">)</span><span class="w"> </span><span class="nf">#&#39;</span><span class="o">,</span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="nv">states</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="ichain-beofre">
<span id="ichain-before"></span><h3><code class="docutils literal notranslate"><span class="pre">ichain-beofre</span></code><a class="headerlink" href="#ichain-beofre" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">ichain-before</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"> </span><span class="nv">this</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="nv">body</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"></span>
<span class="w">                </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="ichain-after">
<span id="id64"></span><h3><code class="docutils literal notranslate"><span class="pre">ichain-after</span></code><a class="headerlink" href="#ichain-after" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">ichain-after</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"> </span><span class="nv">this</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">prog1</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"></span>
<span class="w">                </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="nv">body</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="ichain-intercept">
<span id="id65"></span><h3><code class="docutils literal notranslate"><span class="pre">ichain-intercept%</span></code><a class="headerlink" href="#ichain-intercept" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">ichain-intercept%</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"> </span><span class="nv">this</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">block</span><span class="w"> </span><span class="nv">intercept</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">prog1</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"></span>
<span class="w">                    </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">,@</span><span class="nv">body</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id66">
<span id="id67"></span><h3><code class="docutils literal notranslate"><span class="pre">ichain-intercept</span></code><a class="headerlink" href="#id66" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">ichain-intercept</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"> </span><span class="nv">this</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">block</span><span class="w"> </span><span class="o">,</span><span class="nv">g!intercept</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">macrolet</span><span class="w"> </span><span class="p">((</span><span class="nv">intercept</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="o">`</span><span class="p">(</span><span class="k">return-from</span><span class="w"></span>
<span class="w">                        </span><span class="o">,</span><span class="ss">&#39;,g!intercept</span><span class="w"></span>
<span class="w">                        </span><span class="o">,</span><span class="nv">v</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">prog1</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">,</span><span class="nv">g!indir-env</span><span class="w"></span>
<span class="w">                    </span><span class="o">,</span><span class="nv">g!temp-args</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">,@</span><span class="nv">body</span><span class="p">)))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="alet-hotpatch">
<span id="id68"></span><h3><code class="docutils literal notranslate"><span class="pre">alet-hotpatch%</span></code><a class="headerlink" href="#alet-hotpatch" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">alet-hotpatch%</span><span class="w"> </span><span class="p">(</span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">this</span><span class="p">)</span><span class="w"> </span><span class="o">,@</span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"> </span><span class="o">&#39;</span><span class="ss">:hotpatch</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">args</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">args</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id69">
<span id="id70"></span><h3><code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code><a class="headerlink" href="#id69" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">alet-hotpatch</span><span class="w"> </span><span class="p">(</span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">this</span><span class="p">)</span><span class="w"> </span><span class="o">,@</span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">dlambda</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="ss">:hotpatch</span><span class="w"> </span><span class="p">(</span><span class="nv">closure</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">closure</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">args</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="let-hotpatch">
<span id="id71"></span><h3><code class="docutils literal notranslate"><span class="pre">let-hotpatch</span></code><a class="headerlink" href="#let-hotpatch" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">let-hotpatch</span><span class="w"> </span><span class="p">(</span><span class="nv">letargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!this</span><span class="p">)</span><span class="w"> </span><span class="o">,@</span><span class="nv">letargs</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="o">,</span><span class="nv">g!this</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">dlambda</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="ss">:hotpatch</span><span class="w"> </span><span class="p">(</span><span class="nv">closure</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="o">,</span><span class="nv">g!this</span><span class="w"> </span><span class="nv">closure</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">,</span><span class="nv">g!this</span><span class="w"> </span><span class="nv">args</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="let-binding-transform">
<span id="id72"></span><h3><code class="docutils literal notranslate"><span class="pre">let-binding-transform</span></code><a class="headerlink" href="#let-binding-transform" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">let-binding-transform</span><span class="w"> </span><span class="p">(</span><span class="nv">bs</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">bs</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">symbolp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">bs</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">bs</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="nb">consp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">bs</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">bs</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="no">t</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Bad let bindings&quot;</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">let-binding-transform</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">bs</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sublet">
<span id="id73"></span><h3><code class="docutils literal notranslate"><span class="pre">sublet</span></code><a class="headerlink" href="#sublet" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">sublet</span><span class="w"> </span><span class="p">(</span><span class="nv">bindings%</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">bindings</span><span class="w"> </span><span class="p">(</span><span class="nv">let-binding-transform</span><span class="w"></span>
<span class="w">                    </span><span class="nv">bindings%</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">bindings</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">mapcar</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-name</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nv">bindings</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">list</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">car</span><span class="w"> </span><span class="nv">bindings</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">caddr</span><span class="w"> </span><span class="nv">bindings</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="p">(</span><span class="nv">tree-leaves</span><span class="w"></span>
<span class="w">        </span><span class="nv">body</span><span class="w"></span>
<span class="w">        </span><span class="o">#1=</span><span class="p">(</span><span class="nb">member</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">bindings</span><span class="w"> </span><span class="ss">:key</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">cadr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="o">#1#</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id74">
<span id="id75"></span><h3><code class="docutils literal notranslate"><span class="pre">sublet*</span></code><a class="headerlink" href="#id74" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro sublet* (bindings &amp;rest body)
`(sublet ,bindings
    ,@(mapcar #&#39;macroexpand-1 body)))
</pre></div>
</div>
</section>
<section id="pandoriclet">
<span id="id76"></span><h3><code class="docutils literal notranslate"><span class="pre">pandoriclet</span></code><a class="headerlink" href="#pandoriclet" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro pandoriclet (letargs &amp;rest body)
(let ((letargs (cons
                &#39;(this)
                (let-binding-transform
                    letargs))))
    `(let (,@letargs)
    (setq this ,@(last body))
    ,@(butlast body)
    (dlambda
        (:pandoric-get (sym)
        ,(pandoriclet-get letargs))
        (:pandoric-set (sym val)
        ,(pandoriclet-set letargs))
        (t (&amp;rest args)
        (apply this args))))))
</pre></div>
</div>
</section>
<section id="pandoriclet-get">
<span id="id77"></span><h3><code class="docutils literal notranslate"><span class="pre">pandoriclet-get</span></code><a class="headerlink" href="#pandoriclet-get" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun pandoriclet-get (letargs)
`(case sym
    ,@(mapcar #`((,(car a1)) ,(car a1))
            letargs)
    (t (error
        &quot;Unknown pandoric get: ~a&quot;
        sym))))
</pre></div>
</div>
</section>
<section id="pandoriclet-set">
<span id="id78"></span><h3><code class="docutils literal notranslate"><span class="pre">pandoriclet-set</span></code><a class="headerlink" href="#pandoriclet-set" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun pandoriclet-set (letargs)
`(case sym
    ,@(mapcar #`((,(car a1))
                (setq ,(car a1) val))
            letargs)
    (t (error
        &quot;Unknown pandoric set: ~a&quot;
        sym val))))
</pre></div>
</div>
</section>
<section id="get-pandoric">
<span id="id79"></span><h3><code class="docutils literal notranslate"><span class="pre">get-pandoric</span></code><a class="headerlink" href="#get-pandoric" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">declaim</span><span class="w"> </span><span class="p">(</span><span class="k">inline</span><span class="w"> </span><span class="nv">get-pandoric</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">get-pandoric</span><span class="w"> </span><span class="p">(</span><span class="nv">box</span><span class="w"> </span><span class="nv">sym</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">box</span><span class="w"> </span><span class="ss">:pandoric-get</span><span class="w"> </span><span class="nv">sym</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defsetf</span><span class="w"> </span><span class="nv">get-pandoric</span><span class="w"> </span><span class="p">(</span><span class="nv">box</span><span class="w"> </span><span class="nv">sym</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">val</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">progn</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="o">,</span><span class="nv">box</span><span class="w"> </span><span class="ss">:pandoric-set</span><span class="w"> </span><span class="o">,</span><span class="nv">sym</span><span class="w"> </span><span class="o">,</span><span class="nv">val</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="nv">val</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="with-pandoric">
<span id="id80"></span><h3><code class="docutils literal notranslate"><span class="pre">with-pandoric</span></code><a class="headerlink" href="#with-pandoric" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro! with-pandoric (syms o!box &amp;rest body)
`(symbol-macrolet
    (,@(mapcar #`(,a1 (get-pandoric ,g!box &#39;,a1))
                syms))
    ,@body))
</pre></div>
</div>
</section>
<section id="pandoric-hotpatch">
<span id="id81"></span><h3><code class="docutils literal notranslate"><span class="pre">pandoric-hotpatch</span></code><a class="headerlink" href="#pandoric-hotpatch" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">pandoric-hotpatch</span><span class="w"> </span><span class="p">(</span><span class="nv">box</span><span class="w"> </span><span class="nv">new</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nv">with-pandoric</span><span class="w"> </span><span class="p">(</span><span class="nv">this</span><span class="p">)</span><span class="w"> </span><span class="nv">box</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">new</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="pandoric-recode">
<span id="id82"></span><h3><code class="docutils literal notranslate"><span class="pre">pandoric-recode</span></code><a class="headerlink" href="#pandoric-recode" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">pandoric-recode</span><span class="w"> </span><span class="p">(</span><span class="nv">vars</span><span class="w"> </span><span class="nv">box</span><span class="w"> </span><span class="nv">new</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nv">with-pandoric</span><span class="w"> </span><span class="p">(</span><span class="nv">this</span><span class="w"> </span><span class="o">,@</span><span class="nv">vars</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">box</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="o">,</span><span class="nv">new</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="plambda">
<span id="id83"></span><h3><code class="docutils literal notranslate"><span class="pre">plambda</span></code><a class="headerlink" href="#plambda" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">plambda</span><span class="w"> </span><span class="p">(</span><span class="nv">largs</span><span class="w"> </span><span class="nv">pargs</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">pargs</span><span class="w"> </span><span class="p">(</span><span class="nb">mapcar</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">list</span><span class="w"> </span><span class="nv">pargs</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">this</span><span class="w"> </span><span class="nv">self</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"></span>
<span class="w">        </span><span class="nv">this</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="o">,</span><span class="nv">largs</span><span class="w"> </span><span class="o">,@</span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nv">dlambda</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="ss">:pandoric-get</span><span class="w"> </span><span class="p">(</span><span class="nv">sym</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">,</span><span class="p">(</span><span class="nv">pandoriclet-get</span><span class="w"> </span><span class="nv">pargs</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="ss">:pandoric-set</span><span class="w"> </span><span class="p">(</span><span class="nv">sym</span><span class="w"> </span><span class="nv">val</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="o">,</span><span class="p">(</span><span class="nv">pandoriclet-set</span><span class="w"> </span><span class="nv">pargs</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="no">t</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">args</span><span class="p">)))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="make-stats-counter">
<span id="id84"></span><h3><code class="docutils literal notranslate"><span class="pre">make-stats-counter</span></code><a class="headerlink" href="#make-stats-counter" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">make-stats-counter</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nb">count</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">sum</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">sum-of-squares</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nv">plambda</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">sum</span><span class="w"> </span><span class="nb">count</span><span class="w"> </span><span class="nv">sum-of-squares</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">sum-of-squares</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nb">count</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="defpan">
<span id="id85"></span><h3><code class="docutils literal notranslate"><span class="pre">defpan</span></code><a class="headerlink" href="#defpan" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">defpan</span><span class="w"> </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="nv">args</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="o">,</span><span class="nv">name</span><span class="w"> </span><span class="p">(</span><span class="nv">self</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">args</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="nv">with-pandoric</span><span class="w"> </span><span class="o">,</span><span class="nv">args</span><span class="w"> </span><span class="nv">self</span><span class="w"></span>
<span class="w">        </span><span class="o">,@</span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="k">progn</span><span class="w"> </span><span class="o">,@</span><span class="nv">body</span><span class="p">))))</span><span class="w"></span>



<span class="p">(</span><span class="nv">defpan</span><span class="w"> </span><span class="nv">stats-counter-mean</span><span class="w"> </span><span class="p">(</span><span class="nv">sum</span><span class="w"> </span><span class="nb">count</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="nb">count</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">defpan</span><span class="w"> </span><span class="nv">stats-counter-variance</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">sum-of-squares</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="nb">count</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nb">count</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">sum-of-squares</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">sum</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">stats-counter-mean</span><span class="w"> </span><span class="nv">self</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nb">count</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="nv">defpan</span><span class="w"> </span><span class="nv">stats-counter-stddev</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nv">stats-counter-variance</span><span class="w"> </span><span class="nv">self</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="make-noisy-stats-counter">
<span id="id86"></span><h3><code class="docutils literal notranslate"><span class="pre">make-noisy-stats-counter</span></code><a class="headerlink" href="#make-noisy-stats-counter" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">make-noisy-stats-counter</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nb">count</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">sum</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">sum-of-squares</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nv">plambda</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">sum</span><span class="w"> </span><span class="nb">count</span><span class="w"> </span><span class="nv">sum-of-squares</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">sum-of-squares</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nb">count</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;~&amp;MEAN=~a~%VAR=~a~%STDDEV=~a~%&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">stats-counter-mean</span><span class="w"> </span><span class="nv">self</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">stats-counter-variance</span><span class="w"> </span><span class="nv">self</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">stats-counter-stddev</span><span class="w"> </span><span class="nv">self</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="pandoric-eval">
<span id="id87"></span><h3><code class="docutils literal notranslate"><span class="pre">pandoric-eval</span></code><a class="headerlink" href="#pandoric-eval" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">pandoric-eval-tunnel</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">pandoric-eval</span><span class="w"> </span><span class="p">(</span><span class="nv">vars</span><span class="w"> </span><span class="nv">expr</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">pandoric-eval-tunnel</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">plambda</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">,</span><span class="nv">vars</span><span class="w"> </span><span class="no">t</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">eval</span><span class="w"> </span><span class="o">`</span><span class="p">(</span><span class="nv">with-pandoric</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="ss">&#39;,vars</span><span class="w"> </span><span class="nv">pandoric-eval-tunnel</span><span class="w"></span>
<span class="w">            </span><span class="o">,,</span><span class="nv">expr</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="chapter07">
<span id="chapter07-src-code"></span><h2>Chapter07<a class="headerlink" href="#chapter07" title="Permalink to this heading"></a></h2>
<section id="set-dispatch-macro-character">
<span id="id88"></span><h3><code class="docutils literal notranslate"><span class="pre">set-dispatch-macro-character</span></code><a class="headerlink" href="#set-dispatch-macro-character" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(set-dispatch-macro-character #\# #\f
(lambda (stream sub-char numarg)
    (declare (ignore stream sub-char))
    (setq numarg (or numarg 3))
    (unless (&lt;= numarg 3)
    (error &quot;Bad value for #f: ~a&quot; numarg))
    `(declare (optimize (speed ,numarg)
                        (safety ,(- 3 numarg))))))
</pre></div>
</div>
</section>
<section id="fast-progn">
<span id="id89"></span><h3><code class="docutils literal notranslate"><span class="pre">fast-progn</span></code><a class="headerlink" href="#fast-progn" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro fast-progn (&amp;rest body)
`(locally #f ,@body))
</pre></div>
</div>
</section>
<section id="safe-progn">
<span id="id90"></span><h3><code class="docutils literal notranslate"><span class="pre">safe-progn</span></code><a class="headerlink" href="#safe-progn" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro safe-progn (&amp;rest body)
`(locally #0f ,@body))
</pre></div>
</div>
</section>
<section id="fast-keywords-strip">
<span id="id91"></span><h3><code class="docutils literal notranslate"><span class="pre">fast-keywords-strip</span></code><a class="headerlink" href="#fast-keywords-strip" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">fast-keywords-strip</span><span class="w"> </span><span class="p">(</span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">args</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;&amp;key</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">fast-keywords-strip</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">args</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">consp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">args</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">#1=</span><span class="p">(</span><span class="nv">fast-keywords-strip</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">args</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="no">t</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"> </span><span class="o">#1#</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="defun-with-fast-keywords">
<span id="id92"></span><h3><code class="docutils literal notranslate"><span class="pre">defun-with-fast-keywords</span></code><a class="headerlink" href="#defun-with-fast-keywords" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro! defun-with-fast-keywords
        (name args &amp;rest body)
`(progn
    (defun ,name ,args ,@body)
    (defun ,g!fast-fun
            ,(fast-keywords-strip args)
            ,@body)
    (compile &#39;,g!fast-fun)
    (define-compiler-macro ,name (&amp;rest ,g!rest)
    (destructuring-bind ,args ,g!rest
        (list &#39;,g!fast-fun
            ,@(fast-keywords-strip args))))))
</pre></div>
</div>
</section>
<section id="defun-keywords-test">
<span id="id93"></span><h3><code class="docutils literal notranslate"><span class="pre">defun-keywords-test</span></code><a class="headerlink" href="#defun-keywords-test" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"></span>
<span class="nv">slow-keywords-test</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="k">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">d</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="nv">d</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">compile</span><span class="w"> </span><span class="ss">&#39;slow-keywords-test</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nv">defun-with-fast-keywords</span><span class="w"></span>
<span class="nv">fast-keywords-test</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="k">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">d</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="nv">d</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="keywords-benchmark">
<span id="id94"></span><h3><code class="docutils literal notranslate"><span class="pre">keywords-benchmark</span></code><a class="headerlink" href="#keywords-benchmark" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">keywords-benchmark</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">&quot;Slow keys:~%&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">time</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">slow-keywords-test</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:d</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">:c</span><span class="w"> </span><span class="nv">n</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">&quot;Fast keys:~%&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">time</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">fast-keywords-test</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">:d</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">:c</span><span class="w"> </span><span class="nv">n</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="nb">compile</span><span class="w"> </span><span class="ss">&#39;keywords-benchmark</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="fformat">
<span id="id95"></span><h3><code class="docutils literal notranslate"><span class="pre">fformat</span></code><a class="headerlink" href="#fformat" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">fformat</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">all</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nf">#&#39;</span><span class="nb">format</span><span class="w"> </span><span class="nv">all</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">compile</span><span class="w"> </span><span class="ss">&#39;fformat</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nb">define-compiler-macro</span><span class="w"> </span><span class="nv">fformat</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="k">&amp;whole</span><span class="w"> </span><span class="nv">form</span><span class="w"></span>
<span class="w">                        </span><span class="nc">stream</span><span class="w"> </span><span class="nv">fmt</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">constantp</span><span class="w"> </span><span class="nv">fmt</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nc">stream</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="p">(</span><span class="nb">formatter</span><span class="w"> </span><span class="o">,</span><span class="nv">fmt</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="nc">stream</span><span class="w"> </span><span class="o">,@</span><span class="nv">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">g!stream</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="w"> </span><span class="s">&quot;stream&quot;</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="o">`</span><span class="p">(</span><span class="nb">with-output-to-string</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="nv">g!stream</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="p">(</span><span class="nb">formatter</span><span class="w"> </span><span class="o">,</span><span class="nv">fmt</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nv">g!stream</span><span class="w"> </span><span class="o">,@</span><span class="nv">args</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="nv">form</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="fformat-benchmark">
<span id="id96"></span><h3><code class="docutils literal notranslate"><span class="pre">fformat-benchmark</span></code><a class="headerlink" href="#fformat-benchmark" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">fformat-benchmark</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">&quot;Format:~%&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">time</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="nb">format</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="s">&quot;Hello ~a ~a~%&quot;</span><span class="w"> </span><span class="ss">&#39;world</span><span class="w"> </span><span class="nv">n</span><span class="p">)))</span><span class="w"></span>
<span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">&quot;Fformat:~%&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">time</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">fformat</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="s">&quot;Hello ~a ~a~%&quot;</span><span class="w"> </span><span class="ss">&#39;world</span><span class="w"> </span><span class="nv">n</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="nb">compile</span><span class="w"> </span><span class="ss">&#39;fformat-benchmark</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="dis">
<span id="id97"></span><h3><code class="docutils literal notranslate"><span class="pre">dis</span></code><a class="headerlink" href="#dis" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro dis (args &amp;rest body)
`(disassemble
    (compile nil
    (lambda ,(mapcar (lambda (a)
                        (if (consp a)
                            (cadr a)
                            a))
                        args)
        (declare
        ,@(mapcar
            #`(type ,(car a1) ,(cadr a1))
            (remove-if-not #&#39;consp args)))
        ,@body))))
</pre></div>
</div>
</section>
<section id="pointer">
<span id="id98"></span><h3><code class="docutils literal notranslate"><span class="pre">pointer-&amp;</span></code><a class="headerlink" href="#pointer" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">pointer-&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">obj</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="nv">g!set</span><span class="w"> </span><span class="ss">&#39;,g!temp</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="o">,</span><span class="nv">g!set</span><span class="w"> </span><span class="ss">&#39;,g!temp</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="nv">obj</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="o">,</span><span class="nv">obj</span><span class="w"> </span><span class="o">,</span><span class="nv">g!set</span><span class="p">))))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">pointer-*</span><span class="w"> </span><span class="p">(</span><span class="nv">addr</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">addr</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defsetf</span><span class="w"> </span><span class="nv">pointer-*</span><span class="w"> </span><span class="p">(</span><span class="nv">addr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">val</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="o">,</span><span class="nv">addr</span><span class="w"> </span><span class="o">,</span><span class="nv">val</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defsetf</span><span class="w"> </span><span class="nv">pointer-&amp;</span><span class="w"> </span><span class="p">(</span><span class="nv">addr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">val</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nv">pointer-*</span><span class="w"> </span><span class="o">,</span><span class="nv">addr</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">val</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="with-fast-stack">
<span id="id99"></span><h3><code class="docutils literal notranslate"><span class="pre">with-fast-stack</span></code><a class="headerlink" href="#with-fast-stack" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro! with-fast-stack
        ((sym &amp;key (type &#39;fixnum) (size 1000)
                    (safe-zone 100))
            &amp;rest body)
`(let ((,g!index ,safe-zone)
        (,g!mem (make-array ,(+ size (* 2 safe-zone))
                            :element-type &#39;,type)))
    (declare (type (simple-array ,type) ,g!mem)
            (type fixnum ,g!index))
    (macrolet
    ((,(symb &#39;fast-push- sym) (val)
            `(locally #f
            (setf (aref ,&#39;,g!mem ,&#39;,g!index) ,val)
            (incf ,&#39;,g!index)))
        (,(symb &#39;fast-pop- sym) ()
            `(locally #f
            (decf ,&#39;,g!index)
            (aref ,&#39;,g!mem ,&#39;,g!index)))
        (,(symb &#39;check-stack- sym) ()
            `(progn
            (if (&lt;= ,&#39;,g!index ,,safe-zone)
                (error &quot;Stack underflow: ~a&quot;
                        &#39;,&#39;,sym))
            (if (&lt;= ,,(- size safe-zone)
                    ,&#39;,g!index)
                (error &quot;Stack overflow: ~a&quot;
                        &#39;,&#39;,sym)))))
        ,@body)))
</pre></div>
</div>
</section>
<section id="make-tlist">
<span id="id100"></span><h3><code class="docutils literal notranslate"><span class="pre">make-tlist</span></code><a class="headerlink" href="#make-tlist" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">declaim</span><span class="w"> </span><span class="p">(</span><span class="k">inline</span><span class="w"> </span><span class="nv">make-tlist</span><span class="w"> </span><span class="nv">tlist-left</span><span class="w"></span>
<span class="w">                </span><span class="nv">tlist-right</span><span class="w"> </span><span class="nv">tlist-empty-p</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">make-tlist</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tlist-left</span><span class="w"> </span><span class="p">(</span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">caar</span><span class="w"> </span><span class="nv">tl</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tlist-right</span><span class="w"> </span><span class="p">(</span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">tl</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tlist-empty-p</span><span class="w"> </span><span class="p">(</span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tl</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="tlist-add">
<span id="id101"></span><h3><code class="docutils literal notranslate"><span class="pre">tlist-add</span></code><a class="headerlink" href="#tlist-add" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">declaim</span><span class="w"> </span><span class="p">(</span><span class="k">inline</span><span class="w"> </span><span class="nv">tlist-add-left</span><span class="w"></span>
<span class="w">                </span><span class="nv">tlist-add-right</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tlist-add-left</span><span class="w"> </span><span class="p">(</span><span class="nv">tl</span><span class="w"> </span><span class="nv">it</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tl</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">tlist-empty-p</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tlist-add-right</span><span class="w"> </span><span class="p">(</span><span class="nv">tl</span><span class="w"> </span><span class="nv">it</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="no">nil</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">tlist-empty-p</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="tlist-rem">
<span id="id102"></span><h3><code class="docutils literal notranslate"><span class="pre">tlist-rem</span></code><a class="headerlink" href="#tlist-rem" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(declaim (inline tlist-rem-left))

(defun tlist-rem-left (tl)
(if (tlist-empty-p tl)
    (error &quot;Remove from empty tlist&quot;)
    (let ((x (car tl)))
    (setf (car tl) (cdar tl))
    (if (tlist-empty-p tl)
        (setf (cdr tl) nil)) ;; For gc
    (car x))))
</pre></div>
</div>
</section>
<section id="tlist-update">
<span id="id103"></span><h3><code class="docutils literal notranslate"><span class="pre">tlist-update</span></code><a class="headerlink" href="#tlist-update" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">declaim</span><span class="w"> </span><span class="p">(</span><span class="k">inline</span><span class="w"> </span><span class="nv">tlist-update</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">tlist-update</span><span class="w"> </span><span class="p">(</span><span class="nv">tl</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">tl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">tl</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="counting-cons">
<span id="id104"></span><h3><code class="docutils literal notranslate"><span class="pre">counting-cons</span></code><a class="headerlink" href="#counting-cons" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">number-of-conses</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nb">declaim</span><span class="w"> </span><span class="p">(</span><span class="k">inline</span><span class="w"> </span><span class="nv">counting-cons</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">counting-cons</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">number-of-conses</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="with-conses-counted">
<span id="id105"></span><h3><code class="docutils literal notranslate"><span class="pre">with-conses-counted</span></code><a class="headerlink" href="#with-conses-counted" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">with-conses-counted</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!orig</span><span class="w"> </span><span class="nv">number-of-conses</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="nv">body</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">number-of-conses</span><span class="w"> </span><span class="o">,</span><span class="nv">g!orig</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="counting-push">
<span id="id106"></span><h3><code class="docutils literal notranslate"><span class="pre">counting-push</span></code><a class="headerlink" href="#counting-push" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">counting-push</span><span class="w"> </span><span class="p">(</span><span class="nv">obj</span><span class="w"> </span><span class="nv">stack</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="o">,</span><span class="nv">stack</span><span class="w"> </span><span class="p">(</span><span class="nv">counting-cons</span><span class="w"> </span><span class="o">,</span><span class="nv">obj</span><span class="w"> </span><span class="o">,</span><span class="nv">stack</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="with-cons-pool">
<span id="id107"></span><h3><code class="docutils literal notranslate"><span class="pre">with-cons-pool</span></code><a class="headerlink" href="#with-cons-pool" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">with-cons-pool</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">cons-pool</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">cons-pool-count</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">cons-pool-limit</span><span class="w"> </span><span class="mi">100</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignorable</span><span class="w"> </span><span class="nv">cons-pool</span><span class="w"></span>
<span class="w">                        </span><span class="nv">cons-pool-count</span><span class="w"></span>
<span class="w">                        </span><span class="nv">cons-pool-limit</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cons-pool-cons">
<span id="id108"></span><h3><code class="docutils literal notranslate"><span class="pre">cons-pool-cons</span></code><a class="headerlink" href="#cons-pool-cons" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">cons-pool-cons</span><span class="w"> </span><span class="p">(</span><span class="nv">o!car</span><span class="w"> </span><span class="nv">o!cdr</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nv">cons-pool-count</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">counting-cons</span><span class="w"> </span><span class="o">,</span><span class="nv">g!car</span><span class="w"> </span><span class="o">,</span><span class="nv">g!cdr</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">g!cell</span><span class="w"> </span><span class="nv">cons-pool</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">decf</span><span class="w"> </span><span class="nv">cons-pool-count</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">cons-pool</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">cons-pool</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">,</span><span class="nv">g!cell</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">g!car</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="o">,</span><span class="nv">g!cell</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">g!cdr</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">,</span><span class="nv">g!cell</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="cons-pool-free">
<span id="id109"></span><h3><code class="docutils literal notranslate"><span class="pre">cons-pool-free</span></code><a class="headerlink" href="#cons-pool-free" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">cons-pool-free</span><span class="w"> </span><span class="p">(</span><span class="nv">o!cell</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;=</span><span class="w"> </span><span class="nv">cons-pool-count</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">cons-pool-limit</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">cons-pool-count</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="o">,</span><span class="nv">g!cell</span><span class="p">)</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="o">,</span><span class="nv">g!cell</span><span class="w"> </span><span class="nv">cons-pool</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="make-cons-pool-stack">
<span id="id110"></span><h3><code class="docutils literal notranslate"><span class="pre">make-cons-pool-stack</span></code><a class="headerlink" href="#make-cons-pool-stack" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">make-cons-pool-stack</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">stack</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">dlambda</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="ss">:push</span><span class="w"> </span><span class="p">(</span><span class="nv">elem</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">stack</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">cons-pool-cons</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="nv">stack</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="ss">:pop</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">stack</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Tried to pop an empty stack&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">cell</span><span class="w"> </span><span class="nv">stack</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">elem</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">stack</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">stack</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">stack</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">cons-pool-free</span><span class="w"> </span><span class="nv">cell</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nv">elem</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="make-shared-cons-pool-stack">
<span id="id111"></span><h3><code class="docutils literal notranslate"><span class="pre">make-shared-cons-pool-stack</span></code><a class="headerlink" href="#make-shared-cons-pool-stack" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">with-cons-pool</span><span class="w"></span>
<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">make-shared-cons-pool-stack</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">make-cons-pool-stack</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="with-dynamic-cons-pools">
<span id="id112"></span><h3><code class="docutils literal notranslate"><span class="pre">with-dynamic-cons-pools</span></code><a class="headerlink" href="#with-dynamic-cons-pools" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">with-dynamic-cons-pools</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">body</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">locally</span><span class="w"> </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">special</span><span class="w"> </span><span class="nv">cons-pool</span><span class="w"></span>
<span class="w">                            </span><span class="nv">cons-pool-count</span><span class="w"></span>
<span class="w">                            </span><span class="nv">cons-pool-limit</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="nv">body</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="fill-cons-pool">
<span id="id113"></span><h3><code class="docutils literal notranslate"><span class="pre">fill-cons-pool</span></code><a class="headerlink" href="#fill-cons-pool" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">fill-cons-pool</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">tp</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">cons-pool-count</span><span class="w"></span>
<span class="w">                </span><span class="nv">to</span><span class="w"> </span><span class="nv">cons-pool-limit</span><span class="w"></span>
<span class="w">        </span><span class="nb">do</span><span class="w"> </span><span class="p">(</span><span class="nb">push</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nv">cons-pool-cons</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="nv">tp</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">while</span><span class="w"> </span><span class="nv">tp</span><span class="w"></span>
<span class="w">        </span><span class="nb">do</span><span class="w"> </span><span class="p">(</span><span class="nv">cons-pool-free</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">tp</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bad-3-sn">
<span id="id114"></span><h3><code class="docutils literal notranslate"><span class="pre">bad-3-sn</span></code><a class="headerlink" href="#bad-3-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">bad-3-sn</span><span class="w"></span>
<span class="o">&#39;</span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="good-3-sn">
<span id="id115"></span><h3><code class="docutils literal notranslate"><span class="pre">good-3-sn</span></code><a class="headerlink" href="#good-3-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">good-3-sn</span><span class="w"></span>
<span class="o">&#39;</span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="interpret-sn">
<span id="id116"></span><h3><code class="docutils literal notranslate"><span class="pre">interpret-sn</span></code><a class="headerlink" href="#interpret-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">tracing-interpret-sn</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">interpret-sn</span><span class="w"> </span><span class="p">(</span><span class="nv">data</span><span class="w"> </span><span class="nv">sn</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">step</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">swaps</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">dolist</span><span class="w"> </span><span class="p">(</span><span class="nv">i</span><span class="w"> </span><span class="nv">sn</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">tracing-interpret-sn</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">&quot;Step ~a: ~a~%&quot;</span><span class="w"> </span><span class="nb">step</span><span class="w"> </span><span class="nv">data</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="o">#1=</span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">data</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">#2=</span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">data</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">progn</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">rotatef</span><span class="w"> </span><span class="o">#1#</span><span class="w"> </span><span class="o">#2#</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nv">swaps</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">incf</span><span class="w"> </span><span class="nb">step</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">values</span><span class="w"> </span><span class="nv">swaps</span><span class="w"> </span><span class="nv">data</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="all-sn-perms">
<span id="id117"></span><h3><code class="docutils literal notranslate"><span class="pre">all-sn-perms</span></code><a class="headerlink" href="#all-sn-perms" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">all-sn-perms</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">perms</span><span class="w"> </span><span class="nv">curr</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">funcall</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">alambda</span><span class="w"> </span><span class="p">(</span><span class="nv">left</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">left</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">left</span><span class="p">))</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">left</span><span class="p">)</span><span class="w"> </span><span class="nv">curr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">subseq</span><span class="w"> </span><span class="nv">left</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="nb">subseq</span><span class="w"> </span><span class="nv">left</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">i</span><span class="p">))))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">curr</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">curr</span><span class="w"> </span><span class="nv">perms</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">collect</span><span class="w"> </span><span class="nv">i</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nv">perms</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="average-swaps-calc">
<span id="id118"></span><h3><code class="docutils literal notranslate"><span class="pre">average-swaps-calc</span></code><a class="headerlink" href="#average-swaps-calc" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">average-swaps-calc</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="w"> </span><span class="nv">sn</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="p">(</span><span class="nv">all-sn-perms</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="nv">sum</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">interpret-sn</span><span class="w"> </span><span class="p">(</span><span class="nb">copy-list</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">sn</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">fact</span><span class="w"> </span><span class="nv">n</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="build-batcher-sn">
<span id="id119"></span><h3><code class="docutils literal notranslate"><span class="pre">build-batcher-sn</span></code><a class="headerlink" href="#build-batcher-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">build-batcher-sn</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">(</span><span class="nv">network</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">tee</span><span class="w"> </span><span class="p">(</span><span class="nb">ceiling</span><span class="w"> </span><span class="p">(</span><span class="nb">log</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">p</span><span class="w"> </span><span class="p">(</span><span class="nb">ash</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">tee</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">while</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">q</span><span class="w"> </span><span class="p">(</span><span class="nb">ash</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">tee</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">r</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">d</span><span class="w"> </span><span class="nv">p</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">while</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nb">do</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">logand</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="nv">r</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">d</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="nv">network</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="nv">q</span><span class="w"> </span><span class="p">(</span><span class="nb">ash</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="nv">r</span><span class="w"> </span><span class="nv">p</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="p">(</span><span class="nb">ash</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="mi">-1</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"> </span><span class="nv">network</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="prune-sn-for-median">
<span id="id120"></span><h3><code class="docutils literal notranslate"><span class="pre">prune-sn-for-median</span></code><a class="headerlink" href="#prune-sn-for-median" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">prune-sn-for-median</span><span class="w"> </span><span class="p">(</span><span class="nv">elems</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">mid</span><span class="w"> </span><span class="p">(</span><span class="nb">floor</span><span class="w"> </span><span class="nv">elems</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">evenp</span><span class="w"> </span><span class="nv">elems</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">prune-sn-for-median-aux</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">mid</span><span class="p">)</span><span class="w"> </span><span class="nv">mid</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">prune-sn-for-median-aux</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">mid</span><span class="p">))))))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">prune-sn-for-median-aux</span><span class="w"> </span><span class="p">(</span><span class="nv">network</span><span class="w"> </span><span class="nv">contam</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">network</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">intersection</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">contam</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">prune-sn-for-median-aux</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">remove-duplicates</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">append</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">contam</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">prune-sn-for-median-aux</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">contam</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="prune-sn-for-median-calc">
<span id="id121"></span><h3><code class="docutils literal notranslate"><span class="pre">prune-sn-for-median-calc</span></code><a class="headerlink" href="#prune-sn-for-median-calc" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">prune-sn-for-median-calc</span><span class="w"> </span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">collect</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">sn</span><span class="w"> </span><span class="p">(</span><span class="nv">build-batcher-sn</span><span class="w"> </span><span class="nv">i</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">snp</span><span class="w"> </span><span class="p">(</span><span class="nv">prune-sn-for-median</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">sn</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">i</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">sn</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">snp</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paeth-9-median-sn">
<span id="id122"></span><h3><code class="docutils literal notranslate"><span class="pre">paeth-9-median-sn</span></code><a class="headerlink" href="#paeth-9-median-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">paeth-9-median-sn</span><span class="w"></span>
<span class="o">&#39;</span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paeth-25-median-sn">
<span id="id123"></span><h3><code class="docutils literal notranslate"><span class="pre">paeth-25-median-sn</span></code><a class="headerlink" href="#paeth-25-median-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">paeth-25-median-sn</span><span class="w"></span>
<span class="o">&#39;</span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">14</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">14</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">18</span><span class="w"> </span><span class="mi">19</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="w"> </span><span class="mi">19</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">21</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">20</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">23</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">17</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">21</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">18</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">18</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">19</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">19</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">19</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">13</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">14</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">19</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">14</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sn-to-lambda-form">
<span id="id124"></span><h3><code class="docutils literal notranslate"><span class="pre">sn-to-lambda-form%</span></code><a class="headerlink" href="#sn-to-lambda-form" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun sn-to-lambda-form% (sn)
`(lambda (arr)
    #f
    (declare (type (simple-array fixnum) arr))
    ,@(mapcar
        #`(if (&gt; #1=(aref arr ,(car a1))
                #2=(aref arr ,(cadr a1)))
            (rotatef #1# #2#))
        sn)
    arr))
</pre></div>
</div>
</section>
<section id="id125">
<span id="id126"></span><h3><code class="docutils literal notranslate"><span class="pre">sn-to-lambda-form</span></code><a class="headerlink" href="#id125" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun sn-to-lambda-form (sn)
`(lambda (arr)
    #f
    (declare (type (simple-array fixnum) arr))
    ,@(mapcar
        #`(let ((a #1=(aref arr ,(car a1)))
                (b #2=(aref arr ,(cadr a1))))
            (if (&gt; a b)
            (setf #1# b
                    #2# a)))
        sn)
    arr))
</pre></div>
</div>
</section>
<section id="sortf">
<span id="id127"></span><h3><code class="docutils literal notranslate"><span class="pre">sortf</span></code><a class="headerlink" href="#sortf" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro! sortf (comparator &amp;rest places)
(if places
    `(tagbody
    ,@(mapcar
        #`(let ((,g!a #1=,(nth (car a1) places))
                (,g!b #2=,(nth (cadr a1) places)))
            (if (,comparator ,g!b ,g!a)
                (setf #1# ,g!b
                    #2# ,g!a)))
        (build-batcher-sn (length places))))))
</pre></div>
</div>
</section>
<section id="sort-benchmark-time">
<span id="id128"></span><h3><code class="docutils literal notranslate"><span class="pre">sort-benchmark-time</span></code><a class="headerlink" href="#sort-benchmark-time" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro sort-benchmark-time ()
`(progn
    (setq sorter (compile nil sorter))
    (let ((arr (make-array
                n :element-type &#39;fixnum)))
    (time
        (loop for i from 1 to iters do
        (loop for j from 0 to (1- n) do
            (setf (aref arr j) (random n)))
        (funcall sorter arr))))))
</pre></div>
</div>
</section>
<section id="do-sort-benchmark">
<span id="id129"></span><h3><code class="docutils literal notranslate"><span class="pre">do-sort-benchmark</span></code><a class="headerlink" href="#do-sort-benchmark" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun do-sort-benchmark (n iters)
(let ((rs (make-random-state *random-state*)))
    (format t &quot;CL sort:~%&quot;)
    (let ((sorter
            &#39;(lambda (arr)
                #f
                (declare (type (simple-array fixnum)
                            arr))
                (sort arr #&#39;&lt;))))
    (sort-benchmark-time))

    (setf *random-state* rs)
    (format t &quot;sortf:~%&quot;)
    (let ((sorter
            `(lambda (arr)
                #f
                (declare (type (simple-array fixnum)
                            arr))
                (sortf &lt;
                ,@(loop for i from 0 to (1- n)
                        collect `(aref arr ,i)))
                arr)))
    (sort-benchmark-time))))

(compile &#39;do-sort-benchmark)
</pre></div>
</div>
</section>
<section id="medianf-get-best-sn">
<span id="id130"></span><h3><code class="docutils literal notranslate"><span class="pre">medianf-get-best-sn</span></code><a class="headerlink" href="#medianf-get-best-sn" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun medianf-get-best-sn (n)
(case n
    ((0)  (error &quot;Need more places for medianf&quot;))
    ((9)  paeth-9-median-sn)
    ((25) paeth-25-median-sn)
    (t    (prune-sn-for-median n
            (build-batcher-sn n)))))
</pre></div>
</div>
</section>
<section id="medianf">
<span id="id131"></span><h3><code class="docutils literal notranslate"><span class="pre">medianf</span></code><a class="headerlink" href="#medianf" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro! medianf (&amp;rest places)
`(progn
    ,@(mapcar
        #`(let ((,g!a #1=,(nth (car a1) places))
                (,g!b #2=,(nth (cadr a1) places)))
            (if (&lt; ,g!b ,g!a)
            (setf #1# ,g!b
                    #2# ,g!a)))
        (medianf-get-best-sn (length places)))
    ,(nth (floor (1- (length places)) 2) ; lower
        places)))
</pre></div>
</div>
</section>
</section>
<section id="chapter08">
<span id="chapter08-src-code"></span><h2>Chapter08<a class="headerlink" href="#chapter08" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defvar forth-registers
        &#39;(pstack rstack pc
        dict compiling dtable))
</pre></div>
</div>
<section id="forth-word">
<span id="id132"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-word</span></code><a class="headerlink" href="#forth-word" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defstruct</span><span class="w"> </span><span class="nv">forth-word</span><span class="w"></span>
<span class="nv">name</span><span class="w"> </span><span class="nv">prev</span><span class="w"> </span><span class="nv">immediate</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-lookup">
<span id="id133"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-lookup</span></code><a class="headerlink" href="#forth-lookup" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">forth-lookup</span><span class="w"> </span><span class="p">(</span><span class="nv">w</span><span class="w"> </span><span class="nb">last</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nb">last</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">eql</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-name</span><span class="w"> </span><span class="nb">last</span><span class="p">)</span><span class="w"> </span><span class="nv">w</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nb">last</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth-lookup</span><span class="w"></span>
<span class="w">        </span><span class="nv">w</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-prev</span><span class="w"> </span><span class="nb">last</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-inner-interpreter">
<span id="id134"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-inner-interpreter</span></code><a class="headerlink" href="#forth-inner-interpreter" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">forth-inner-interpreter</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">loop</span><span class="w"></span>
<span class="w">    </span><span class="nb">do</span><span class="w"> </span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">functionp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pc</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pc</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">consp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pc</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">pc</span><span class="p">)</span><span class="w"> </span><span class="nv">rstack</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pc</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">null</span><span class="w"> </span><span class="nv">pc</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">rstack</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="no">t</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pc</span><span class="p">)</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">pc</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="nv">until</span><span class="w"> </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">pc</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">null</span><span class="w"> </span><span class="nv">rstack</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="prim-form">
<span id="id135"></span><h3><code class="docutils literal notranslate"><span class="pre">prim-form</span></code><a class="headerlink" href="#prim-form" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="c1">;; Prim-form: (name immediate . forms)</span><span class="w"></span>
<span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">forth-prim-forms</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">def-forth-naked-prim</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">code</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="ss">&#39;,code</span><span class="w"> </span><span class="nv">forth-prim-forms</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">code</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nv">def-forth-naked-prim</span><span class="w"></span>
<span class="w">    </span><span class="o">,@</span><span class="nv">code</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">pc</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="prim-forms">
<span id="id136"></span><h3><code class="docutils literal notranslate"><span class="pre">prim-forms</span></code><a class="headerlink" href="#prim-forms" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">nop</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nb">*</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">drop</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">dup</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"> </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">swap</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">rotatef</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nb">print</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">print</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">&gt;r</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"> </span><span class="nv">rstack</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">r&gt;</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">rstack</span><span class="p">)</span><span class="w"> </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="go-forth">
<span id="id137"></span><h3><code class="docutils literal notranslate"><span class="pre">go-forth</span></code><a class="headerlink" href="#go-forth" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defmacro!</span><span class="w"> </span><span class="nv">go-forth</span><span class="w"> </span><span class="p">(</span><span class="nv">o!forth</span><span class="w"> </span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">words</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">dolist</span><span class="w"> </span><span class="p">(</span><span class="nv">w</span><span class="w"> </span><span class="ss">&#39;,words</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="o">,</span><span class="nv">g!forth</span><span class="w"> </span><span class="nv">w</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib">
<span id="id138"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib</span></code><a class="headerlink" href="#forth-stdlib" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="nv">forth-stdlib</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">forth-stdlib-add</span><span class="w"> </span><span class="p">(</span><span class="k">&amp;rest</span><span class="w"> </span><span class="nv">all</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">forth-stdlib</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">nconc</span><span class="w"> </span><span class="nv">forth-stdlib</span><span class="w"></span>
<span class="w">                </span><span class="ss">&#39;,all</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="new-forth">
<span id="id139"></span><h3><code class="docutils literal notranslate"><span class="pre">new-forth</span></code><a class="headerlink" href="#new-forth" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">new-forth</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nv">alet</span><span class="w"> </span><span class="o">,</span><span class="nv">forth-registers</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">dtable</span><span class="w"> </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth-install-prims</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">dolist</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="w"> </span><span class="nv">forth-stdlib</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">plambda</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">forth-registers</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">word</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-lookup</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">dict</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">word</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">forth-handle-found</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">forth-handle-not-found</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-install-prims">
<span id="id140"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-install-prims</span></code><a class="headerlink" href="#forth-install-prims" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>;; Prim-form: (name immediate . forms)
(defmacro forth-install-prims ()
`(progn
    ,@(mapcar
        #`(let ((thread (lambda ()
                        ,@(cddr a1))))
            (setf dict
                (make-forth-word
                    :name &#39;,(car a1)
                    :prev dict
                    :immediate ,(cadr a1)
                    :thread thread))
            (setf (gethash thread dtable)
                &#39;,(cddr a1)))
        forth-prim-forms)))
</pre></div>
</div>
</section>
<section id="forth-prims">
<span id="id141"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-prims</span></code><a class="headerlink" href="#forth-prims" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">[</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="c1">; &lt;- t means immediate</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">compiling</span><span class="w"> </span><span class="no">nil</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">]</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="c1">; &lt;- not immediate</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">compiling</span><span class="w"> </span><span class="no">t</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-compile-in">
<span id="id142"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-compile-in</span></code><a class="headerlink" href="#forth-compile-in" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">forth-compile-in</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">dict</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">nconc</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">dict</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">,</span><span class="nv">v</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-handle-found">
<span id="id143"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-handle-found</span></code><a class="headerlink" href="#forth-handle-found" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">forth-handle-found</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="nv">compiling</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-immediate</span><span class="w"> </span><span class="nv">word</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth-compile-in</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">word</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">progn</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">word</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth-inner-interpreter</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-handle-not-found">
<span id="id144"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-handle-not-found</span></code><a class="headerlink" href="#forth-handle-not-found" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">forth-handle-not-found</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">consp</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;quote</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">compiling</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">forth-compile-in</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">consp</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;postpone</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">word</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-lookup</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="nv">dict</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="nv">word</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Postpone failed: ~a&quot;</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">v</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">forth-compile-in</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">word</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">symbolp</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Word ~a not found&quot;</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="no">t</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">compiling</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">forth-compile-in</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-create-name-immediate">
<span id="id145"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-create-name-immediate</span></code><a class="headerlink" href="#forth-create-name-immediate" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">dict</span><span class="w"> </span><span class="p">(</span><span class="nv">make-forth-word</span><span class="w"> </span><span class="ss">:prev</span><span class="w"> </span><span class="nv">dict</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-name</span><span class="w"> </span><span class="nv">dict</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">immediate</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-immediate</span><span class="w"> </span><span class="nv">dict</span><span class="p">)</span><span class="w"> </span><span class="no">t</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-create">
<span id="id146"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-create</span></code><a class="headerlink" href="#forth-stdlib-add-create" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">create</span><span class="w"></span>
<span class="w">    </span><span class="nv">]</span><span class="w"> </span><span class="nv">create</span><span class="w"> </span><span class="nv">]</span><span class="w"> </span><span class="nv">[</span><span class="w"></span>
<span class="ss">&#39;{</span><span class="w"> </span><span class="nv">name</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-name-immediate">
<span id="id147"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-name-immediate</span></code><a class="headerlink" href="#forth-stdlib-add-name-immediate" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="p">(</span><span class="nv">postpone</span><span class="w"> </span><span class="nv">[</span><span class="p">)</span><span class="w"> </span><span class="nv">[</span><span class="w"></span>
<span class="ss">&#39;}</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">immediate</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-prim">
<span id="id148"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-prim-&#64;-!</span></code><a class="headerlink" href="#forth-prim" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">@</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">!</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">location</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">location</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-unary-word-definer">
<span id="id149"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-unary-word-definer</span></code><a class="headerlink" href="#forth-unary-word-definer" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro forth-unary-word-definer (&amp;rest words)
`(progn
    ,@(mapcar
        #`(def-forth-prim ,a1 nil
            (push (,a1 (pop pstack))
                pstack))
        words)))
</pre></div>
</div>
</section>
<section id="forth-binary-word-definer">
<span id="id150"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-binary-word-definer</span></code><a class="headerlink" href="#forth-binary-word-definer" title="Permalink to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defmacro! forth-binary-word-definer (&amp;rest words)
`(progn
    ,@(mapcar
        #`(def-forth-prim ,a1 nil
            (let ((,g!top (pop pstack)))
            (push (,a1 (pop pstack)
                        ,g!top)
                    pstack)))
        words)))
</pre></div>
</div>
</section>
<section id="forth-unary-word-definers">
<span id="id151"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-unary-word-definers</span></code><a class="headerlink" href="#forth-unary-word-definers" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-unary-word-definer</span><span class="w"></span>
<span class="nb">not</span><span class="w"> </span><span class="nb">car</span><span class="w"> </span><span class="nb">cdr</span><span class="w"> </span><span class="nb">cadr</span><span class="w"> </span><span class="nb">caddr</span><span class="w"> </span><span class="nb">cadddr</span><span class="w"></span>
<span class="nb">oddp</span><span class="w"> </span><span class="nb">evenp</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nv">forth-binary-word-definer</span><span class="w"></span>
<span class="nb">eq</span><span class="w"> </span><span class="nb">equal</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="nb">-</span><span class="w"> </span><span class="nb">/</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="nb">&lt;</span><span class="w"> </span><span class="nb">&gt;</span><span class="w"> </span><span class="nb">&lt;=</span><span class="w"> </span><span class="nb">&gt;=</span><span class="w"></span>
<span class="nb">max</span><span class="w"> </span><span class="nb">min</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="nb">or</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-prim-branch-if">
<span id="id152"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-prim-branch-if</span></code><a class="headerlink" href="#forth-prim-branch-if" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">def-forth-naked-prim</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">pc</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">pc</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-drop">
<span id="id153"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-drop</span></code><a class="headerlink" href="#forth-stdlib-add-drop" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nv">r&gt;</span><span class="w"> </span><span class="nv">drop</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;exit</span><span class="w"> </span><span class="nv">name</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-prim-compile-here">
<span id="id154"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-prim-compile-here</span></code><a class="headerlink" href="#forth-prim-compile-here" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">def-forth-naked-prim</span><span class="w"> </span><span class="nb">compile</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">dict</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">nconc</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">dict</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">pc</span><span class="p">))))</span><span class="w"></span>
<span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">pc</span><span class="p">)))</span><span class="w"></span>

<span class="p">(</span><span class="nv">def-forth-prim</span><span class="w"> </span><span class="nv">here</span><span class="w"> </span><span class="no">nil</span><span class="w"></span>
<span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"> </span><span class="nv">dict</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nv">pstack</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-compile">
<span id="id155"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-compile</span></code><a class="headerlink" href="#forth-stdlib-add-compile" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nb">compile</span><span class="w"> </span><span class="nb">not</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">nop</span><span class="w"></span>
<span class="w">    </span><span class="nv">here</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;if</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">immediate</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-here">
<span id="id156"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-here</span></code><a class="headerlink" href="#forth-stdlib-add-here" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nb">compile</span><span class="w"> </span><span class="nv">nop</span><span class="w"></span>
<span class="w">    </span><span class="nv">here</span><span class="w"> </span><span class="nv">swap</span><span class="w"> </span><span class="nv">!</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;then</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">immediate</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-abs">
<span id="id157"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-abs</span></code><a class="headerlink" href="#forth-stdlib-add-abs" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">swap</span><span class="w"> </span><span class="nb">-</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;negate</span><span class="w"> </span><span class="nv">name</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nv">dup</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nb">&lt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">negate</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;abs</span><span class="w"> </span><span class="nv">name</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-swap">
<span id="id158"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-swap</span></code><a class="headerlink" href="#forth-stdlib-add-swap" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nb">compile</span><span class="w"> </span><span class="ss">&#39;t</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">nop</span><span class="w"></span>
<span class="w">    </span><span class="nv">here</span><span class="w"> </span><span class="nv">swap</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">nop</span><span class="w"></span>
<span class="w">    </span><span class="nv">here</span><span class="w"> </span><span class="nv">swap</span><span class="w"> </span><span class="nv">!</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;else</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">immediate</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-mod2">
<span id="id159"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-mod2</span></code><a class="headerlink" href="#forth-stdlib-add-mod2" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nb">evenp</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">else</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;mod2</span><span class="w"> </span><span class="nv">name</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-stdlib-add-again">
<span id="id160"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-stdlib-add-again</span></code><a class="headerlink" href="#forth-stdlib-add-again" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">forth-stdlib-add</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nb">compile</span><span class="w"> </span><span class="nv">nop</span><span class="w"></span>
<span class="w">    </span><span class="nv">here</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;begin</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">immediate</span><span class="w"></span>
<span class="nv">{</span><span class="w"> </span><span class="nb">compile</span><span class="w"> </span><span class="ss">&#39;t</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"></span>
<span class="w">    </span><span class="nb">compile</span><span class="w"> </span><span class="nv">nop</span><span class="w"></span>
<span class="w">    </span><span class="nv">here</span><span class="w"> </span><span class="nv">!</span><span class="w"> </span><span class="nv">}</span><span class="w"> </span><span class="ss">&#39;again</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">immediate</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="get-forth-thread">
<span id="id161"></span><h3><code class="docutils literal notranslate"><span class="pre">get-forth-thread</span></code><a class="headerlink" href="#get-forth-thread" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">get-forth-thread</span><span class="w"> </span><span class="p">(</span><span class="nv">forth</span><span class="w"> </span><span class="nv">word</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nv">with-pandoric</span><span class="w"> </span><span class="p">(</span><span class="nv">dict</span><span class="p">)</span><span class="w"> </span><span class="nv">forth</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth-word-thread</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth-lookup</span><span class="w"> </span><span class="nv">word</span><span class="w"> </span><span class="nv">dict</span><span class="p">))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="print-forth-thread">
<span id="id162"></span><h3><code class="docutils literal notranslate"><span class="pre">print-forth-thread</span></code><a class="headerlink" href="#print-forth-thread" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">print-forth-thread</span><span class="w"> </span><span class="p">(</span><span class="nv">forth</span><span class="w"> </span><span class="nv">word</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="vg">*print-circle*</span><span class="w"> </span><span class="no">t</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">print</span><span class="w"> </span><span class="p">(</span><span class="nv">get-forth-thread</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="nv">word</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="no">t</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="flubify-aux">
<span id="id163"></span><h3><code class="docutils literal notranslate"><span class="pre">flubify-aux</span></code><a class="headerlink" href="#flubify-aux" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">flubify-aux</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="nv">alambda</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">c</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">gethash</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">prim-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">assemble-flub</span><span class="w"></span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="nb">funcall</span><span class="w"></span>
<span class="w">                </span><span class="o">,</span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">prim-ht</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">c</span><span class="p">))))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">gethash</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">thread-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">assemble-flub</span><span class="w"></span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nf">#&#39;</span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">                                </span><span class="nv">thread-ht</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">c</span><span class="p">))))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">assemble-flub</span><span class="w"></span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">pop</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">go</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">go-ht</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">c</span><span class="p">))))</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="nb">consp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">flubify</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">prim-ht</span><span class="w"></span>
<span class="w">                    </span><span class="nv">thread-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="nv">c</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="no">t</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">assemble-flub</span><span class="w"></span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="ss">&#39;,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">pstack</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">c</span><span class="p">))))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="assemble-flub">
<span id="id164"></span><h3><code class="docutils literal notranslate"><span class="pre">assemble-flub</span></code><a class="headerlink" href="#assemble-flub" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">assemble-flub</span><span class="w"> </span><span class="p">(</span><span class="nv">form</span><span class="w"> </span><span class="nb">rest</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="nv">go-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">list*</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="nv">go-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nv">form</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nb">rest</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">list*</span><span class="w"> </span><span class="o">,</span><span class="nv">form</span><span class="w"></span>
<span class="w">            </span><span class="o">,</span><span class="nb">rest</span><span class="p">)))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="flubify">
<span id="id165"></span><h3><code class="docutils literal notranslate"><span class="pre">flubify</span></code><a class="headerlink" href="#flubify" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">flubify</span><span class="w"> </span><span class="p">(</span><span class="nv">forth</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">prim-ht</span><span class="w"></span>
<span class="w">                </span><span class="nv">thread-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="nb">unless</span><span class="w"> </span><span class="o">#1=</span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">thread-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="o">#1#</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">go-ht</span><span class="w"> </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">funcall</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">alambda</span><span class="w"> </span><span class="p">(</span><span class="nv">c</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="nv">c</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="nv">go-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">gensym</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">c</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">((</span><span class="nb">consp</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">c</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nv">flubify</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">prim-ht</span><span class="w"></span>
<span class="w">                        </span><span class="nv">thread-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nv">self</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">c</span><span class="p">))))</span><span class="w"></span>
<span class="w">        </span><span class="nv">thread</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="o">#1#</span><span class="w"> </span><span class="p">(</span><span class="nb">nconc</span><span class="w"> </span><span class="o">#1#</span><span class="w"> </span><span class="p">(</span><span class="nb">funcall</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nv">flubify-aux</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="nv">thread</span><span class="p">))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="compile-flubified">
<span id="id166"></span><h3><code class="docutils literal notranslate"><span class="pre">compile-flubified</span></code><a class="headerlink" href="#compile-flubified" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">compile-flubified</span><span class="w"> </span><span class="p">(</span><span class="nv">thread</span><span class="w"> </span><span class="nv">thread-ht</span><span class="p">)</span><span class="w"></span>
<span class="o">`</span><span class="p">(</span><span class="k">labels</span><span class="w"> </span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">collect</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">maphash</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">k</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nv">k</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">push</span><span class="w"></span>
<span class="w">                    </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">                        </span><span class="p">(</span><span class="k">tagbody</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">v</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="nv">collect</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="nv">thread-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"> </span><span class="nv">collect</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="nf">#&#39;</span><span class="o">,</span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">thread-ht</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="flubify-thread-shaker">
<span id="id167"></span><h3><code class="docutils literal notranslate"><span class="pre">flubify-thread-shaker</span></code><a class="headerlink" href="#flubify-thread-shaker" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">flubify-thread-shaker</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">forth</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">ht</span><span class="w"> </span><span class="nv">tmp-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"> </span><span class="nb">compile</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">tmp-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">return-from</span><span class="w"> </span><span class="nv">flubify-thread-shaker</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">tmp-ht</span><span class="p">)</span><span class="w"> </span><span class="no">t</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nb">cond</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">consp</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">flubify-thread-shaker</span><span class="w"></span>
<span class="w">        </span><span class="nv">forth</span><span class="w"> </span><span class="p">(</span><span class="nb">cddr</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="nv">ht</span><span class="w"></span>
<span class="w">        </span><span class="nv">tmp-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"> </span><span class="nb">compile</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">consp</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="nb">compile</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Can&#39;t convert compiling word to lisp&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">consp</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">flubify-thread-shaker</span><span class="w"></span>
<span class="w">        </span><span class="nv">forth</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="nv">ht</span><span class="w"></span>
<span class="w">        </span><span class="nv">tmp-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"> </span><span class="nb">compile</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">flubify-thread-shaker</span><span class="w"></span>
<span class="w">        </span><span class="nv">forth</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"> </span><span class="nv">ht</span><span class="w"></span>
<span class="w">        </span><span class="nv">tmp-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"> </span><span class="nb">compile</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">ht</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">functionp</span><span class="w"> </span><span class="nv">thread</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">ht</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">with-pandoric</span><span class="w"> </span><span class="p">(</span><span class="nv">dtable</span><span class="p">)</span><span class="w"> </span><span class="nv">forth</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">dtable</span><span class="p">)))))))</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="forth-to-lisp">
<span id="id168"></span><h3><code class="docutils literal notranslate"><span class="pre">forth-to-lisp</span></code><a class="headerlink" href="#forth-to-lisp" title="Permalink to this heading"></a></h3>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">forth-to-lisp</span><span class="w"> </span><span class="p">(</span><span class="nv">forth</span><span class="w"> </span><span class="nv">word</span><span class="p">)</span><span class="w"></span>
<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">thread</span><span class="w"> </span><span class="p">(</span><span class="nv">get-forth-thread</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="nv">word</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">shaker-ht</span><span class="w"> </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">prim-ht</span><span class="w"> </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">thread-ht</span><span class="w"> </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">branch-if</span><span class="w"> </span><span class="p">(</span><span class="nv">get-forth-thread</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="ss">&#39;branch-if</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nb">compile</span><span class="w"> </span><span class="p">(</span><span class="nv">get-forth-thread</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="ss">&#39;compile</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">flubify-thread-shaker</span><span class="w"></span>
<span class="w">    </span><span class="nv">forth</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">shaker-ht</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">make-hash-table</span><span class="p">)</span><span class="w"> </span><span class="nv">branch-if</span><span class="w"> </span><span class="nb">compile</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nb">maphash</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">k</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">declare</span><span class="w"> </span><span class="p">(</span><span class="k">ignore</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="nv">prim-ht</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="nv">shaker-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="nv">flubify</span><span class="w"> </span><span class="nv">forth</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">prim-ht</span><span class="w"> </span><span class="nv">thread-ht</span><span class="w"> </span><span class="nv">branch-if</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">pstack</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">(</span><span class="nv">collect</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">maphash</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">k</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nb">gethash</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="nv">prim-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">butlast</span><span class="w"> </span><span class="nv">v</span><span class="p">)))</span><span class="w"></span>
<span class="w">                        </span><span class="nv">collect</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="nv">shaker-ht</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">nreverse</span><span class="w"> </span><span class="nv">collect</span><span class="p">)))</span><span class="w"></span>
<span class="w">        </span><span class="o">,</span><span class="p">(</span><span class="nv">compile-flubified</span><span class="w"></span>
<span class="w">            </span><span class="nv">thread</span><span class="w"> </span><span class="nv">thread-ht</span><span class="p">)))))</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="specification.html" class="btn btn-neutral float-left" title="术语表" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="production-code.html" class="btn btn-neutral float-right" title="生产代码" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2022, oneforalone, Treyenuo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>